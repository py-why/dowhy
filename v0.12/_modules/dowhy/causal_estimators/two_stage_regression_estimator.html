
<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B139P18WHM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-B139P18WHM');
    </script>
    
    <title>dowhy.causal_estimators.two_stage_regression_estimator &#8212; DoWhy  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=949a1ff5" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=0c6e27e1"></script>
    <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/dowhy/causal_estimators/two_stage_regression_estimator';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/dowhy-logo-small.png" class="logo__image only-light" alt="DoWhy  documentation - Home"/>
    <script>document.write(`<img src="../../../_static/dowhy-logo-small.png" class="logo__image only-dark" alt="DoWhy  documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../getting_started/index.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../user_guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../example_notebooks/nb_index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../cite.html">
                        Citing this package
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../contributing.html">
                        Contributing
                      </a>
                    </li>
                
            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../../dowhy.html">
                        dowhy package
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../../code_repo.html">
                        Release notes
                      </a>
                    </li>
                
                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item"><div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        v0.12
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
        <dl>
            <dt>Releases</dt>
            <dd><a href="/dowhy/v0.9.1/index.html">v0.9.1</a></dd>
            <dd><a href="/dowhy/v0.9/index.html">v0.9</a></dd>
            <dd><a href="/dowhy/v0.8/index.html">v0.8</a></dd>
            <dd><a href="/dowhy/v0.7.1/index.html">v0.7.1</a></dd>
            <dd><a href="/dowhy/v0.7/index.html">v0.7</a></dd>
            <dd><a href="/dowhy/v0.6/index.html">v0.6</a></dd>
            <dd><a href="/dowhy/v0.5.1/index.html">v0.5.1</a></dd>
            <dd><a href="/dowhy/v0.5/index.html">v0.5</a></dd>
            <dd><a href="/dowhy/v0.4/index.html">v0.4</a></dd>
            <dd><a href="/dowhy/v0.2/index.html">v0.2</a></dd>
            <dd><a href="/dowhy/v0.11.1/index.html">v0.11.1</a></dd>
            <dd><a href="/dowhy/v0.11/index.html">v0.11</a></dd>
            <dd><a href="/dowhy/v0.10.1/index.html">v0.10.1</a></dd>
            <dd><a href="/dowhy/v0.10/index.html">v0.10</a></dd>
            <dd><a href="/dowhy/v0.1.1-alpha/index.html">v0.1.1-alpha</a></dd>
        </dl>        
        <dl>
            <dt>Branches</dt>
            <dd><a href="">main</a></dd>
        </dl>        
    </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../getting_started/index.html">
                        Getting Started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../user_guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../example_notebooks/nb_index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../cite.html">
                        Citing this package
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../contributing.html">
                        Contributing
                      </a>
                    </li>
                
            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links-2">
                    More
                </button>
                <ul id="pst-nav-more-links-2" class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../../dowhy.html">
                        dowhy package
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link dropdown-item nav-internal" href="../../../code_repo.html">
                        Release notes
                      </a>
                    </li>
                
                </ul>
            </li>
            
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        v0.12
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
        <dl>
            <dt>Releases</dt>
            <dd><a href="/dowhy/v0.9.1/index.html">v0.9.1</a></dd>
            <dd><a href="/dowhy/v0.9/index.html">v0.9</a></dd>
            <dd><a href="/dowhy/v0.8/index.html">v0.8</a></dd>
            <dd><a href="/dowhy/v0.7.1/index.html">v0.7.1</a></dd>
            <dd><a href="/dowhy/v0.7/index.html">v0.7</a></dd>
            <dd><a href="/dowhy/v0.6/index.html">v0.6</a></dd>
            <dd><a href="/dowhy/v0.5.1/index.html">v0.5.1</a></dd>
            <dd><a href="/dowhy/v0.5/index.html">v0.5</a></dd>
            <dd><a href="/dowhy/v0.4/index.html">v0.4</a></dd>
            <dd><a href="/dowhy/v0.2/index.html">v0.2</a></dd>
            <dd><a href="/dowhy/v0.11.1/index.html">v0.11.1</a></dd>
            <dd><a href="/dowhy/v0.11/index.html">v0.11</a></dd>
            <dd><a href="/dowhy/v0.10.1/index.html">v0.10.1</a></dd>
            <dd><a href="/dowhy/v0.10/index.html">v0.10</a></dd>
            <dd><a href="/dowhy/v0.1.1-alpha/index.html">v0.1.1-alpha</a></dd>
        </dl>        
        <dl>
            <dt>Branches</dt>
            <dd><a href="">main</a></dd>
        </dl>        
    </div>
</div></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../causal_estimators.html" class="nav-link">dowhy.causal_estimators</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">dowhy.causal...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for dowhy.causal_estimators.two_stage_regression_estimator</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">dowhy.causal_estimator</span> <span class="kn">import</span> <span class="n">CausalEstimate</span><span class="p">,</span> <span class="n">CausalEstimator</span>
<span class="kn">from</span> <span class="nn">dowhy.causal_estimators.linear_regression_estimator</span> <span class="kn">import</span> <span class="n">LinearRegressionEstimator</span>
<span class="kn">from</span> <span class="nn">dowhy.causal_identifier</span> <span class="kn">import</span> <span class="n">EstimandType</span><span class="p">,</span> <span class="n">IdentifiedEstimand</span>
<span class="kn">from</span> <span class="nn">dowhy.utils.api</span> <span class="kn">import</span> <span class="n">parse_state</span>


<div class="viewcode-block" id="TwoStageRegressionEstimator"><a class="viewcode-back" href="../../../dowhy.causal_estimators.html#dowhy.causal_estimators.two_stage_regression_estimator.TwoStageRegressionEstimator">[docs]</a><span class="k">class</span> <span class="nc">TwoStageRegressionEstimator</span><span class="p">(</span><span class="n">CausalEstimator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute treatment effect whenever the effect is fully mediated by</span>
<span class="sd">    another variable (front-door) or when there is an instrument available.</span>

<span class="sd">    Currently only supports a linear model for the effects.</span>

<span class="sd">    Supports additional parameters as listed below.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># First stage statistical model</span>
    <span class="n">DEFAULT_FIRST_STAGE_MODEL</span> <span class="o">=</span> <span class="n">LinearRegressionEstimator</span>
    <span class="c1"># Second stage statistical model</span>
    <span class="n">DEFAULT_SECOND_STAGE_MODEL</span> <span class="o">=</span> <span class="n">LinearRegressionEstimator</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">identified_estimand</span><span class="p">:</span> <span class="n">IdentifiedEstimand</span><span class="p">,</span>
        <span class="n">test_significance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">evaluate_effect_strength</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">confidence_intervals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">num_null_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CausalEstimator</span><span class="o">.</span><span class="n">DEFAULT_NUMBER_OF_SIMULATIONS_STAT_TEST</span><span class="p">,</span>
        <span class="n">num_simulations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CausalEstimator</span><span class="o">.</span><span class="n">DEFAULT_NUMBER_OF_SIMULATIONS_CI</span><span class="p">,</span>
        <span class="n">sample_size_fraction</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CausalEstimator</span><span class="o">.</span><span class="n">DEFAULT_SAMPLE_SIZE_FRACTION</span><span class="p">,</span>
        <span class="n">confidence_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">CausalEstimator</span><span class="o">.</span><span class="n">DEFAULT_CONFIDENCE_LEVEL</span><span class="p">,</span>
        <span class="n">need_conditional_estimates</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
        <span class="n">num_quantiles_to_discretize_cont_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CausalEstimator</span><span class="o">.</span><span class="n">NUM_QUANTILES_TO_DISCRETIZE_CONT_COLS</span><span class="p">,</span>
        <span class="n">first_stage_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CausalEstimator</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">CausalEstimator</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">second_stage_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CausalEstimator</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">CausalEstimator</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param identified_estimand: probability expression</span>
<span class="sd">            representing the target identified estimand to estimate.</span>
<span class="sd">        :param test_significance: Binary flag or a string indicating whether to test significance and by which method. All estimators support test_significance=&quot;bootstrap&quot; that estimates a p-value for the obtained estimate using the bootstrap method. Individual estimators can override this to support custom testing methods. The bootstrap method supports an optional parameter, num_null_simulations. If False, no testing is done. If True, significance of the estimate is tested using the custom method if available, otherwise by bootstrap.</span>
<span class="sd">        :param evaluate_effect_strength: (Experimental) whether to evaluate the strength of effect</span>
<span class="sd">        :param confidence_intervals: Binary flag or a string indicating whether the confidence intervals should be computed and which method should be used. All methods support estimation of confidence intervals using the bootstrap method by using the parameter confidence_intervals=&quot;bootstrap&quot;. The bootstrap method takes in two arguments (num_simulations and sample_size_fraction) that can be optionally specified in the params dictionary. Estimators may also override this to implement their own confidence interval method. If this parameter is False, no confidence intervals are computed. If True, confidence intervals are computed by the estimator&#39;s specific method if available, otherwise through bootstrap</span>
<span class="sd">        :param num_null_simulations: The number of simulations for testing the</span>
<span class="sd">            statistical significance of the estimator</span>
<span class="sd">        :param num_simulations: The number of simulations for finding the</span>
<span class="sd">            confidence interval (and/or standard error) for a estimate</span>
<span class="sd">        :param sample_size_fraction: The size of the sample for the bootstrap</span>
<span class="sd">            estimator</span>
<span class="sd">        :param confidence_level: The confidence level of the confidence</span>
<span class="sd">            interval estimate</span>
<span class="sd">        :param need_conditional_estimates: Boolean flag indicating whether</span>
<span class="sd">            conditional estimates should be computed. Defaults to True if</span>
<span class="sd">            there are effect modifiers in the graph</span>
<span class="sd">        :param num_quantiles_to_discretize_cont_cols: The number of quantiles</span>
<span class="sd">            into which a numeric effect modifier is split, to enable</span>
<span class="sd">            estimation of conditional treatment effect over it.</span>
<span class="sd">        :param first_stage_model: First stage estimator to be used. Default is</span>
<span class="sd">            linear regression.</span>
<span class="sd">        :param second_stage_model: Second stage estimator to be used. Default</span>
<span class="sd">            is linear regression.</span>
<span class="sd">        :param kwargs: (optional) Additional estimator-specific parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">identified_estimand</span><span class="o">=</span><span class="n">identified_estimand</span><span class="p">,</span>
            <span class="n">test_significance</span><span class="o">=</span><span class="n">test_significance</span><span class="p">,</span>
            <span class="n">evaluate_effect_strength</span><span class="o">=</span><span class="n">evaluate_effect_strength</span><span class="p">,</span>
            <span class="n">confidence_intervals</span><span class="o">=</span><span class="n">confidence_intervals</span><span class="p">,</span>
            <span class="n">num_null_simulations</span><span class="o">=</span><span class="n">num_null_simulations</span><span class="p">,</span>
            <span class="n">num_simulations</span><span class="o">=</span><span class="n">num_simulations</span><span class="p">,</span>
            <span class="n">sample_size_fraction</span><span class="o">=</span><span class="n">sample_size_fraction</span><span class="p">,</span>
            <span class="n">confidence_level</span><span class="o">=</span><span class="n">confidence_level</span><span class="p">,</span>
            <span class="n">need_conditional_estimates</span><span class="o">=</span><span class="n">need_conditional_estimates</span><span class="p">,</span>
            <span class="n">num_quantiles_to_discretize_cont_cols</span><span class="o">=</span><span class="n">num_quantiles_to_discretize_cont_cols</span><span class="p">,</span>
            <span class="n">first_stage_model</span><span class="o">=</span><span class="n">first_stage_model</span><span class="p">,</span>
            <span class="n">second_stage_model</span><span class="o">=</span><span class="n">second_stage_model</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;INFO: Using Two Stage Regression Estimator&quot;</span><span class="p">)</span>
        <span class="c1"># Check if the treatment is one-dimensional</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">treatment_variable</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;cannot handle more than one treatment variable&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="n">modified_target_estimand</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="p">)</span>
        <span class="n">modified_target_estimand</span><span class="o">.</span><span class="n">identifier_method</span> <span class="o">=</span> <span class="s2">&quot;backdoor&quot;</span>
        <span class="n">modified_target_estimand</span><span class="o">.</span><span class="n">backdoor_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">mediation_first_stage_confounders</span>
        <span class="k">if</span> <span class="n">first_stage_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_stage_model</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">first_stage_model</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_stage_model</span><span class="p">,</span> <span class="n">CausalEstimator</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">first_stage_model</span><span class="p">(</span>
                    <span class="n">modified_target_estimand</span><span class="p">,</span>
                    <span class="n">test_significance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_significance_test</span><span class="p">,</span>
                    <span class="n">evaluate_effect_strength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_effect_strength_eval</span><span class="p">,</span>
                    <span class="n">confidence_intervals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_confidence_intervals</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_stage_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">DEFAULT_FIRST_STAGE_MODEL</span><span class="p">(</span>
                <span class="n">modified_target_estimand</span><span class="p">,</span>
                <span class="n">test_significance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_significance_test</span><span class="p">,</span>
                <span class="n">evaluate_effect_strength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_effect_strength_eval</span><span class="p">,</span>
                <span class="n">confidence_intervals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_confidence_intervals</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;First stage model not provided. Defaulting to sklearn.linear_model.LinearRegression.&quot;</span><span class="p">)</span>

        <span class="n">modified_target_estimand</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="p">)</span>
        <span class="n">modified_target_estimand</span><span class="o">.</span><span class="n">identifier_method</span> <span class="o">=</span> <span class="s2">&quot;backdoor&quot;</span>
        <span class="n">modified_target_estimand</span><span class="o">.</span><span class="n">backdoor_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">mediation_second_stage_confounders</span>
        <span class="k">if</span> <span class="n">second_stage_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_second_stage_model</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">second_stage_model</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">second_stage_model</span><span class="p">,</span> <span class="n">CausalEstimator</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">second_stage_model</span><span class="p">(</span>
                    <span class="n">modified_target_estimand</span><span class="p">,</span>
                    <span class="n">test_significance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_significance_test</span><span class="p">,</span>
                    <span class="n">evaluate_effect_strength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_effect_strength_eval</span><span class="p">,</span>
                    <span class="n">confidence_intervals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_confidence_intervals</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_second_stage_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">DEFAULT_SECOND_STAGE_MODEL</span><span class="p">(</span>
                <span class="n">modified_target_estimand</span><span class="p">,</span>
                <span class="n">test_significance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_significance_test</span><span class="p">,</span>
                <span class="n">evaluate_effect_strength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_effect_strength_eval</span><span class="p">,</span>
                <span class="n">confidence_intervals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_confidence_intervals</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Second stage model not provided. Defaulting to backdoor.linear_regression.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">estimand_type</span> <span class="o">==</span> <span class="n">EstimandType</span><span class="o">.</span><span class="n">NONPARAMETRIC_NDE</span><span class="p">:</span>
            <span class="n">modified_target_estimand</span><span class="o">.</span><span class="n">identifier_method</span> <span class="o">=</span> <span class="s2">&quot;backdoor&quot;</span>
            <span class="n">modified_target_estimand</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_second_stage_model_nde</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_second_stage_model</span><span class="p">)(</span>
                <span class="n">modified_target_estimand</span><span class="p">,</span>
                <span class="n">test_significance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_significance_test</span><span class="p">,</span>
                <span class="n">evaluate_effect_strength</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_effect_strength_eval</span><span class="p">,</span>
                <span class="n">confidence_intervals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_confidence_intervals</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>

<div class="viewcode-block" id="TwoStageRegressionEstimator.fit"><a class="viewcode-back" href="../../../dowhy.causal_estimators.html#dowhy.causal_estimators.two_stage_regression_estimator.TwoStageRegressionEstimator.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">effect_modifier_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">_</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the estimator with data for effect estimation</span>
<span class="sd">        :param data: data frame containing the data</span>
<span class="sd">        :param treatment: name of the treatment variable</span>
<span class="sd">        :param outcome: name of the outcome variable</span>
<span class="sd">        :param iv_instrument_name: Name of the specific instrumental variable</span>
<span class="sd">            to be used. Needs to be one of the IVs identified in the</span>
<span class="sd">            identification step. Default is to use all the IV variables</span>
<span class="sd">            from the identification step.</span>
<span class="sd">        :param effect_modifiers: Variables on which to compute separate</span>
<span class="sd">                    effects, or return a heterogeneous effect function. Not all</span>
<span class="sd">                    methods support this currently.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_encoders</span><span class="p">()</span>  <span class="c1"># Forget any existing encoders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_effect_modifiers</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">effect_modifier_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">treatment_variable</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;cannot handle more than one treatment variable&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">identifier_method</span> <span class="o">==</span> <span class="s2">&quot;frontdoor&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Front-door variable used:&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">get_frontdoor_variables</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frontdoor_variables_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">get_frontdoor_variables</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frontdoor_variables_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frontdoor_variables_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Only singleton frontdoor variables are supported for estimation using TwoStageRegression.&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_frontdoor_variables</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_frontdoor_variables_names</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_frontdoor_variables</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No front-door variable present. Two stage regression is not applicable&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">identifier_method</span> <span class="o">==</span> <span class="s2">&quot;mediation&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Mediators used:&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">get_mediator_variables</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mediators_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">get_mediator_variables</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mediators_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mediators_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Only singleton mediator variables are supported for estimation using TwoStageRegression.&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mediators</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mediators_names</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mediators</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No mediator variable present. Two stage regression is not applicable&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">identifier_method</span> <span class="o">==</span> <span class="s2">&quot;iv&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Instrumental variables used:&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">get_instrumental_variables</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_instrumental_variables_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">get_instrumental_variables</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instrumental_variables_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instrumental_variables</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_instrumental_variables_names</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_instrumental_variables</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;No instrumental variable present. Two stage regression is not applicable&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">identifier_method</span> <span class="o">==</span> <span class="s2">&quot;frontdoor&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_stage_model</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">outcome_variable</span> <span class="o">=</span> <span class="n">parse_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frontdoor_variables_names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">identifier_method</span> <span class="o">==</span> <span class="s2">&quot;mediation&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_stage_model</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">outcome_variable</span> <span class="o">=</span> <span class="n">parse_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mediators_names</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_first_stage_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">effect_modifier_names</span><span class="o">=</span><span class="n">effect_modifier_names</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">identifier_method</span> <span class="o">==</span> <span class="s2">&quot;frontdoor&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_second_stage_model</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">treatment_variable</span> <span class="o">=</span> <span class="n">parse_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frontdoor_variables_names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">identifier_method</span> <span class="o">==</span> <span class="s2">&quot;mediation&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_second_stage_model</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">treatment_variable</span> <span class="o">=</span> <span class="n">parse_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mediators_names</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_second_stage_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">effect_modifier_names</span><span class="o">=</span><span class="n">effect_modifier_names</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">estimand_type</span> <span class="o">==</span> <span class="n">EstimandType</span><span class="o">.</span><span class="n">NONPARAMETRIC_NDE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_second_stage_model_nde</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">identifier_method</span> <span class="o">=</span> <span class="s2">&quot;backdoor&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_second_stage_model_nde</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">effect_modifier_names</span><span class="o">=</span><span class="n">effect_modifier_names</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="TwoStageRegressionEstimator.estimate_effect"><a class="viewcode-back" href="../../../dowhy.causal_estimators.html#dowhy.causal_estimators.two_stage_regression_estimator.TwoStageRegressionEstimator.estimate_effect">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_effect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">treatment_value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">control_value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">target_units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">_</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_units</span> <span class="o">=</span> <span class="n">target_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_treatment_value</span> <span class="o">=</span> <span class="n">treatment_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_control_value</span> <span class="o">=</span> <span class="n">control_value</span>

        <span class="n">estimate_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># First stage</span>
        <span class="n">first_stage_estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_stage_model</span><span class="o">.</span><span class="n">estimate_effect</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">,</span>
            <span class="n">treatment_value</span><span class="o">=</span><span class="n">treatment_value</span><span class="p">,</span>
            <span class="n">target_units</span><span class="o">=</span><span class="n">target_units</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Second Stage</span>
        <span class="n">second_stage_estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_second_stage_model</span><span class="o">.</span><span class="n">estimate_effect</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">,</span>
            <span class="n">treatment_value</span><span class="o">=</span><span class="n">treatment_value</span><span class="p">,</span>
            <span class="n">target_units</span><span class="o">=</span><span class="n">target_units</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Combining the two estimates</span>
        <span class="n">natural_indirect_effect</span> <span class="o">=</span> <span class="n">first_stage_estimate</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">second_stage_estimate</span><span class="o">.</span><span class="n">value</span>
        <span class="c1"># This same estimate is valid for frontdoor as well as mediation (NIE)</span>
        <span class="n">estimate_value</span> <span class="o">=</span> <span class="n">natural_indirect_effect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_estimator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_symbolic_estimator</span><span class="p">(</span>
            <span class="n">first_stage_estimate</span><span class="o">.</span><span class="n">realized_estimand_expr</span><span class="p">,</span>
            <span class="n">second_stage_estimate</span><span class="o">.</span><span class="n">realized_estimand_expr</span><span class="p">,</span>
            <span class="n">estimand_type</span><span class="o">=</span><span class="n">EstimandType</span><span class="o">.</span><span class="n">NONPARAMETRIC_NIE</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">estimand_type</span> <span class="o">==</span> <span class="n">EstimandType</span><span class="o">.</span><span class="n">NONPARAMETRIC_NDE</span><span class="p">:</span>

            <span class="n">total_effect_estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_second_stage_model_nde</span><span class="o">.</span><span class="n">estimate_effect</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">,</span>
                <span class="n">treatment_value</span><span class="o">=</span><span class="n">treatment_value</span><span class="p">,</span>
                <span class="n">target_units</span><span class="o">=</span><span class="n">target_units</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">natural_direct_effect</span> <span class="o">=</span> <span class="n">total_effect_estimate</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">natural_indirect_effect</span>
            <span class="n">estimate_value</span> <span class="o">=</span> <span class="n">natural_direct_effect</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_estimator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_symbolic_estimator</span><span class="p">(</span>
                <span class="n">first_stage_estimate</span><span class="o">.</span><span class="n">realized_estimand_expr</span><span class="p">,</span>
                <span class="n">second_stage_estimate</span><span class="o">.</span><span class="n">realized_estimand_expr</span><span class="p">,</span>
                <span class="n">total_effect_estimate</span><span class="o">.</span><span class="n">realized_estimand_expr</span><span class="p">,</span>
                <span class="n">estimand_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">estimand_type</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">estimate</span> <span class="o">=</span> <span class="n">CausalEstimate</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">treatment_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">treatment_variable</span><span class="p">,</span>
            <span class="n">outcome_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">outcome_variable</span><span class="p">,</span>
            <span class="n">estimate</span><span class="o">=</span><span class="n">estimate_value</span><span class="p">,</span>
            <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">,</span>
            <span class="n">treatment_value</span><span class="o">=</span><span class="n">treatment_value</span><span class="p">,</span>
            <span class="n">target_estimand</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="p">,</span>
            <span class="n">realized_estimand_expr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbolic_estimator</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">estimate</span><span class="o">.</span><span class="n">add_estimator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">estimate</span></div>

<div class="viewcode-block" id="TwoStageRegressionEstimator.build_first_stage_features"><a class="viewcode-back" href="../../../dowhy.causal_estimators.html#dowhy.causal_estimators.two_stage_regression_estimator.TwoStageRegressionEstimator.build_first_stage_features">[docs]</a>    <span class="k">def</span> <span class="nf">build_first_stage_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">treatment_vals</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">treatment_variable</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_observed_common_causes_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">observed_common_causes_vals</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_observed_common_causes_names</span><span class="p">]</span>
            <span class="n">observed_common_causes_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="n">observed_common_causes_vals</span><span class="p">,</span> <span class="s2">&quot;observed_common_causes&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effect_modifier_names</span><span class="p">:</span>
            <span class="n">effect_modifiers_vals</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_effect_modifier_names</span><span class="p">]</span>
            <span class="n">effect_modifiers_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="n">effect_modifiers_vals</span><span class="p">,</span> <span class="s2">&quot;effect_modifiers&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">treatment_vals</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">treatment_vals</span> <span class="o">=</span> <span class="n">treatment_vals</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">treatment_vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provided treatment values and dataframe should have the same length.&quot;</span><span class="p">)</span>
        <span class="c1"># Bulding the feature matrix</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">treatment_vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Number of samples&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">treatment_variable</span><span class="p">)))</span>
        <span class="n">treatment_2d</span> <span class="o">=</span> <span class="n">treatment_vals</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">treatment_variable</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_observed_common_causes_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">treatment_2d</span><span class="p">,</span> <span class="n">observed_common_causes_vals</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">treatment_2d</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_effect_modifier_names</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">treatment_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">curr_treatment</span> <span class="o">=</span> <span class="n">treatment_2d</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">new_features</span> <span class="o">=</span> <span class="n">curr_treatment</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">effect_modifiers_vals</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">features</span><span class="p">,</span> <span class="n">new_features</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>  <span class="c1"># converting to float in case of binary treatment and no other variables</span>
        <span class="c1"># features = sm.add_constant(features, has_constant=&#39;add&#39;) # to add an intercept term</span>
        <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="TwoStageRegressionEstimator.construct_symbolic_estimator"><a class="viewcode-back" href="../../../dowhy.causal_estimators.html#dowhy.causal_estimators.two_stage_regression_estimator.TwoStageRegressionEstimator.construct_symbolic_estimator">[docs]</a>    <span class="k">def</span> <span class="nf">construct_symbolic_estimator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">first_stage_symbolic</span><span class="p">,</span> <span class="n">second_stage_symbolic</span><span class="p">,</span> <span class="n">total_effect_symbolic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">estimand_type</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">nie_symbolic</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">first_stage_symbolic</span> <span class="o">+</span> <span class="s2">&quot;)*(&quot;</span> <span class="o">+</span> <span class="n">second_stage_symbolic</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">if</span> <span class="n">estimand_type</span> <span class="o">==</span> <span class="n">EstimandType</span><span class="o">.</span><span class="n">NONPARAMETRIC_NIE</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nie_symbolic</span>
        <span class="k">elif</span> <span class="n">estimand_type</span> <span class="o">==</span> <span class="n">EstimandType</span><span class="o">.</span><span class="n">NONPARAMETRIC_NDE</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">total_effect_symbolic</span> <span class="o">+</span> <span class="s2">&quot;) - (&quot;</span> <span class="o">+</span> <span class="n">nie_symbolic</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span></div></div>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2022, PyWhy contributors.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.14.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>