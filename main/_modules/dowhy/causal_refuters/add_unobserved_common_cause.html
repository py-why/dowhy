
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B139P18WHM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B139P18WHM');
</script>
    <title>dowhy.causal_refuters.add_unobserved_common_cause &#8212; DoWhy  documentation</title>
<script>
  document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
  document.documentElement.dataset.theme = localStorage.getItem("theme") || "light"
</script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=92025949c220c2e29695" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=92025949c220c2e29695" rel="stylesheet">


  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">
    <div class="bd-header-announcement container-fluid" id="banner">
      

    </div>

    
    <nav class="bd-header navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="bd-header__inner container-xl">

  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    <p class="title logo__title">DoWhy  documentation</p>
  
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="fas fa-bars"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../getting_started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../user_guide/index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../example_notebooks/nb_index.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../dowhy.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../contributing.html">
  Contributing
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../code_repo.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
      <div class="navbar-end-item">
        
<div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        main-branch
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
        <dl>
            <dt>Releases</dt>
            <!-- hard-coding the old versions, as no further old version will be added -->
            <!-- It would be nice if this opened the same page in an older version, but that seems to be overkill
                 right now. Therefore defaulting to the starting page (index). -->
            <dd><a href="/dowhy/v0.8/index.html">v0.8</a></dd>
            <dd><a href="/dowhy/v0.7.1/index.html">v0.7.1</a></dd>
            <dd><a href="/dowhy/v0.7/index.html">v0.7</a></dd>
            <dd><a href="/dowhy/v0.6/index.html">v0.6</a></dd>
            <dd><a href="/dowhy/v0.5.1/index.html">v0.5.1</a></dd>
            <dd><a href="/dowhy/v0.5/index.html">v0.5</a></dd>
            <dd><a href="/dowhy/v0.4/index.html">v0.4</a></dd>
            <dd><a href="/dowhy/v0.2/index.html">v0.2</a></dd>
            <dd><a href="/dowhy/v0.1.1-alpha/index.html">v0.1.1-alpha</a></dd>
            <dd><a href="/dowhy/v0.1-alpha/index.html">v0.1-alpha</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="add_unobserved_common_cause.html">main</a></dd>
        </dl>
    </div>
</div>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="bd-container container-xl">
      <div class="bd-container__inner row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="bd-sidebar-primary col-12 col-md-3 bd-sidebar">
  <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
  </div>
  <div class="sidebar-end-items">
  </div>
</div>


          


<div class="bd-sidebar-secondary d-none d-xl-block col-xl-2 bd-toc">
  
</div>


          
          
          <div class="bd-content col-12 col-md-9 col-xl-7">
              
              <article class="bd-article" role="main">
                
  <h1>Source code for dowhy.causal_refuters.add_unobserved_common_cause</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">dowhy.causal_refuter</span> <span class="kn">import</span> <span class="n">CausalRefutation</span>
<span class="kn">from</span> <span class="nn">dowhy.causal_refuter</span> <span class="kn">import</span> <span class="n">CausalRefuter</span>
<span class="kn">from</span> <span class="nn">dowhy.causal_estimator</span> <span class="kn">import</span> <span class="n">CausalEstimator</span>
<span class="kn">from</span> <span class="nn">dowhy.causal_refuters.linear_sensitivity_analyzer</span> <span class="kn">import</span> <span class="n">LinearSensitivityAnalyzer</span>
<span class="kn">from</span> <span class="nn">dowhy.causal_estimators.linear_regression_estimator</span> <span class="kn">import</span> <span class="n">LinearRegressionEstimator</span>

<div class="viewcode-block" id="AddUnobservedCommonCause"><a class="viewcode-back" href="../../../dowhy.causal_refuters.html#dowhy.causal_refuters.add_unobserved_common_cause.AddUnobservedCommonCause">[docs]</a><span class="k">class</span> <span class="nc">AddUnobservedCommonCause</span><span class="p">(</span><span class="n">CausalRefuter</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Add an unobserved confounder for refutation.</span>

<span class="sd">    Supports additional parameters that can be specified in the refute_estimate() method.</span>

<span class="sd">    - &#39;confounders_effect_on_treatment&#39;: how the simulated confounder affects the value of treatment. This can be linear (for continuous treatment) or binary_flip (for binary treatment)</span>
<span class="sd">    - &#39;confounders_effect_on_outcome&#39;: how the simulated confounder affects the value of outcome. This can be linear (for continuous outcome) or binary_flip (for binary outcome)</span>
<span class="sd">    - &#39;effect_strength_on_treatment&#39;: parameter for the strength of the effect of simulated confounder on treatment. For linear effect, it is the regression coeffient. For binary_flip, it is the probability that simulated confounder&#39;s effect flips the value of treatment from 0 to 1 (or vice-versa).</span>
<span class="sd">    - &#39;effect_strength_on_outcome&#39;: parameter for the strength of the effect of simulated confounder on outcome. For linear effect, it is the regression coeffient. For binary_flip, it is the probability that simulated confounder&#39;s effect flips the value of outcome from 0 to 1 (or vice-versa).</span>

<span class="sd">    TODO: Needs an interpretation module</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the parameters required for the refuter.</span>

<span class="sd">        If effect_strength_on_treatment or effect_strength_on_outcome is not</span>
<span class="sd">        given, it is calculated automatically as a range between the</span>
<span class="sd">        minimum and maximum effect strength of observed confounders on treatment</span>
<span class="sd">        and outcome respectively.</span>

<span class="sd">        :param confounders_effect_on_treatment: str : The type of effect on the treatment due to the unobserved confounder. Possible values are [&#39;binary_flip&#39;, &#39;linear&#39;]</span>
<span class="sd">        :param confounders_effect_on_outcome: str : The type of effect on the outcome due to the unobserved confounder. Possible values are [&#39;binary_flip&#39;, &#39;linear&#39;]</span>
<span class="sd">        :param effect_strength_on_treatment: float, numpy.ndarray: This refers to the strength of the confounder on treatment. For a linear effect, it behaves like the regression coeffecient. For a binary flip it is the probability with which it can invert the value of the treatment.</span>
<span class="sd">        :param effect_strength_on_outcome: float, numpy.ndarray: This refers to the strength of the confounder on outcome. For a linear effect, it behaves like the regression coefficient. For a binary flip, it is the probability with which it can invert the value of the outcome.</span>
<span class="sd">        :param effect_fraction_on_treatment: float: If effect_strength_on_treatment is not provided, this parameter decides the effect strength of the simulated confounder as a fraction of the effect strength of observed confounders on treatment. Defaults to 1.</span>
<span class="sd">        :param effect_fraction_on_outcome: float: If effect_strength_on_outcome is not provided, this parameter decides the effect strength of the simulated confounder as a fraction of the effect strength of observed confounders on outcome. Defaults to 1.</span>
<span class="sd">        :param plotmethod: string: Type of plot to be shown. If None, no plot is generated. This parameter is used only only when more than one treatment confounder effect values or outcome confounder effect values are provided. Default is &quot;colormesh&quot;. Supported values are &quot;contour&quot;, &quot;colormesh&quot; when more than one value is provided for both confounder effect value parameters; &quot;line&quot; when provided for only one of them.</span>
<span class="sd">        :param simulated_method_name: method type to add unobserved common cause. &quot;linear-partial-R2&quot; for linear sensitivity analysis</span>
<span class="sd">        :param percent_change_estimate: It is the percentage of reduction of treatment estimate that could alter the results (default = 1)</span>
<span class="sd">                                        if percent_change_estimate = 1, the robustness value describes the strength of association of confounders with treatment and outcome in order to reduce the estimate by 100% i.e bring it down to 0.</span>
<span class="sd">        :param confounder_increases_estimate: True implies that confounder increases the absolute value of estimate and vice versa. (Default = False)</span>
<span class="sd">        :param benchmark_common_causes: names of variables for bounding strength of confounders</span>
<span class="sd">        :param significance_level: confidence interval for statistical inference(default = 0.05)</span>
<span class="sd">        :param null_hypothesis_effect: assumed effect under the null hypothesis</span>
<span class="sd">        :param plot_estimate: Generate contour plot for estimate while performing sensitivity analysis. (default = True). </span>
<span class="sd">                              To override the setting, set plot_estimate = False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_t</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;confounders_effect_on_treatment&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;confounders_effect_on_treatment&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s2">&quot;binary_flip&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_y</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;confounders_effect_on_outcome&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;confounders_effect_on_outcome&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s2">&quot;linear&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;effect_strength_on_treatment&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;effect_strength_on_treatment&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;effect_strength_on_outcome&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;effect_strength_on_outcome&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frac_strength_treatment</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;effect_fraction_on_treatment&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;effect_fraction_on_treatment&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frac_strength_outcome</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;effect_fraction_on_outcome&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;effect_fraction_on_outcome&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulated_method_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;simulated_method_name&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;simulated_method_name&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s2">&quot;linear_based&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotmethod</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;plotmethod&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;plotmethod&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s2">&quot;colormesh&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percent_change_estimate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;percent_change_estimate&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;percent_change_estimate&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">significance_level</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;significance_level&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;significance_level&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="mf">0.05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confounder_increases_estimate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;confounder_increases_estimate&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;confounder_increases_estimate&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_common_causes</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;benchmark_common_causes&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;benchmark_common_causes&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">null_hypothesis_effect</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;null_hypothesis_effect&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;null_hypothesis_effect&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_estimate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;plot_estimate&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;plot_estimate&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="AddUnobservedCommonCause.infer_default_kappa_t"><a class="viewcode-back" href="../../../dowhy.causal_refuters.html#dowhy.causal_refuters.add_unobserved_common_cause.AddUnobservedCommonCause.infer_default_kappa_t">[docs]</a>    <span class="k">def</span> <span class="nf">infer_default_kappa_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">len_kappa_t</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Infer default effect strength of simulated confounder on treatment.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">observed_common_causes_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">get_backdoor_variables</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed_common_causes_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">observed_common_causes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">observed_common_causes_names</span><span class="p">]</span>
            <span class="n">observed_common_causes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There needs to be at least one common cause to&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;automatically compute the default value of kappa_t.&quot;</span><span class="o">+</span>
                <span class="s2">&quot; Provide a value for kappa_t&quot;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_treatment_name</span><span class="p">]</span>
        <span class="c1"># Standardizing the data</span>
        <span class="n">observed_common_causes</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_t</span> <span class="o">==</span> <span class="s2">&quot;binary_flip&quot;</span><span class="p">:</span>
            <span class="c1"># Fit a model containing all confounders and compare predictions</span>
            <span class="c1"># using all features compared to all features except a given</span>
            <span class="c1"># confounder.</span>
            <span class="n">tmodel</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">tpred</span> <span class="o">=</span> <span class="n">tmodel</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">flips</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>  <span class="nb">range</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">oldval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
                <span class="n">observed_common_causes</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">tcap</span> <span class="o">=</span> <span class="n">tmodel</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">observed_common_causes</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldval</span>
                <span class="n">flips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tcap</span><span class="o">-</span><span class="n">tpred</span><span class="p">))</span><span class="o">/</span><span class="n">tpred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">flips</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">flips</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_t</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="c1"># Estimating the regression coefficient from standardized features to t</span>
            <span class="n">corrcoef_var_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">std_dev_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">max_coeff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">corrcoef_var_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">std_dev_t</span>
            <span class="n">min_coeff</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">corrcoef_var_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">std_dev_t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_t</span> <span class="o">+</span>
                    <span class="s2">&quot;&#39; method not supported for confounders&#39; effect on treatment&quot;</span><span class="p">)</span>

        <span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_min_max_coeff</span><span class="p">(</span><span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frac_strength_treatment</span><span class="p">)</span>
        <span class="c1"># By default, return a plot with 10 points</span>
        <span class="c1"># consider 10 values of the effect of the unobserved confounder</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_coeff</span> <span class="o">-</span> <span class="n">min_coeff</span><span class="p">)</span><span class="o">/</span><span class="n">len_kappa_t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(Min, Max) kappa_t for observed common causes, (</span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">max_coeff</span><span class="p">,</span> <span class="n">min_coeff</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">max_coeff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_compute_min_max_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span><span class="p">,</span> <span class="n">effect_strength_fraction</span><span class="p">):</span>
        <span class="n">max_coeff</span> <span class="o">=</span> <span class="n">effect_strength_fraction</span> <span class="o">*</span> <span class="n">max_coeff</span>
        <span class="n">min_coeff</span> <span class="o">=</span> <span class="n">effect_strength_fraction</span> <span class="o">*</span> <span class="n">min_coeff</span>
        <span class="k">return</span> <span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span>

<div class="viewcode-block" id="AddUnobservedCommonCause.infer_default_kappa_y"><a class="viewcode-back" href="../../../dowhy.causal_refuters.html#dowhy.causal_refuters.add_unobserved_common_cause.AddUnobservedCommonCause.infer_default_kappa_y">[docs]</a>    <span class="k">def</span> <span class="nf">infer_default_kappa_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">len_kappa_y</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Infer default effect strength of simulated confounder on treatment.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">observed_common_causes_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="o">.</span><span class="n">get_backdoor_variables</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed_common_causes_names</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">observed_common_causes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">observed_common_causes_names</span><span class="p">]</span>
            <span class="n">observed_common_causes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There needs to be at least one common cause to&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;automatically compute the default value of kappa_y.&quot;</span><span class="o">+</span>
                <span class="s2">&quot; Provide a value for kappa_y&quot;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_outcome_name</span><span class="p">]</span>
        <span class="c1"># Standardizing the data</span>
        <span class="n">observed_common_causes</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_y</span> <span class="o">==</span> <span class="s2">&quot;binary_flip&quot;</span><span class="p">:</span>
            <span class="c1"># Fit a model containing all confounders and compare predictions</span>
            <span class="c1"># using all features compared to all features except a given</span>
            <span class="c1"># confounder.</span>
            <span class="n">ymodel</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ypred</span> <span class="o">=</span> <span class="n">ymodel</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">flips</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>  <span class="nb">range</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">oldval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
                <span class="n">observed_common_causes</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ycap</span> <span class="o">=</span> <span class="n">ymodel</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">observed_common_causes</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldval</span>
                <span class="n">flips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ycap</span><span class="o">-</span><span class="n">ypred</span><span class="p">))</span><span class="o">/</span><span class="n">ypred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">flips</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">flips</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_y</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">corrcoef_var_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">observed_common_causes</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">std_dev_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">max_coeff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">corrcoef_var_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">std_dev_y</span>
            <span class="n">min_coeff</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">corrcoef_var_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">std_dev_y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_y</span> <span class="o">+</span>
                    <span class="s2">&quot;&#39; method not supported for confounders&#39; effect on outcome&quot;</span><span class="p">)</span>
        <span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_min_max_coeff</span><span class="p">(</span><span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frac_strength_outcome</span><span class="p">)</span>
        <span class="c1"># By default, return a plot with 10 points</span>
        <span class="c1"># consider 10 values of the effect of the unobserved confounder</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_coeff</span> <span class="o">-</span> <span class="n">min_coeff</span><span class="p">)</span><span class="o">/</span><span class="n">len_kappa_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(Min, Max) kappa_y for observed common causes, (</span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">max_coeff</span><span class="p">,</span> <span class="n">min_coeff</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">max_coeff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_coeff</span><span class="p">,</span> <span class="n">max_coeff</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span></div>

<div class="viewcode-block" id="AddUnobservedCommonCause.refute_estimate"><a class="viewcode-back" href="../../../dowhy.causal_refuters.html#dowhy.causal_refuters.add_unobserved_common_cause.AddUnobservedCommonCause.refute_estimate">[docs]</a>    <span class="k">def</span> <span class="nf">refute_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function attempts to add an unobserved common cause to the outcome and the treatment. At present, we have implemented the behavior for one dimensional behaviors for continuous</span>
<span class="sd">        and binary variables. This function can either take single valued inputs or a range of inputs. The function then looks at the data type of the input and then decides on the course of</span>
<span class="sd">        action.</span>

<span class="sd">        :return: CausalRefuter: An object that contains the estimated effect and a new effect and the name of the refutation used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulated_method_name</span> <span class="o">==</span> <span class="s2">&quot;linear-partial-R2&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="o">.</span><span class="n">estimator</span><span class="p">,</span> <span class="n">LinearRegressionEstimator</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Currently only LinearRegressionEstimator is supported for Sensitivity Analysis&quot;</span><span class="p">)</span>

            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">_effect_modifier_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The current implementation does not support effect modifiers&quot;</span><span class="p">)</span>

            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frac_strength_outcome</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frac_strength_outcome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_strength_treatment</span>

            <span class="n">analyzer</span> <span class="o">=</span> <span class="n">LinearSensitivityAnalyzer</span><span class="p">(</span><span class="n">estimator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="o">.</span><span class="n">estimator</span><span class="p">,</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">treatment_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_treatment_name</span><span class="p">,</span> 
            <span class="n">percent_change_estimate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">percent_change_estimate</span><span class="p">,</span> <span class="n">significance_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">significance_level</span><span class="p">,</span> <span class="n">benchmark_common_causes</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_common_causes</span><span class="p">,</span> <span class="n">null_hypothesis_effect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">null_hypothesis_effect</span><span class="p">,</span>
            <span class="n">frac_strength_treatment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_strength_treatment</span><span class="p">,</span> <span class="n">frac_strength_outcome</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_strength_outcome</span><span class="p">,</span> <span class="n">common_causes_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">_observed_common_causes</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            
            <span class="n">analyzer</span><span class="o">.</span><span class="n">check_sensitivity</span><span class="p">(</span><span class="n">plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_estimate</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">analyzer</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_default_kappa_t</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_default_kappa_y</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span> <span class="c1"># Deal with single value inputs</span>
            <span class="n">new_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
            <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_confounders_effect</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">)</span>
            <span class="n">new_estimator</span> <span class="o">=</span> <span class="n">CausalEstimator</span><span class="o">.</span><span class="n">get_estimator_object</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="p">)</span>
            <span class="n">new_effect</span> <span class="o">=</span> <span class="n">new_estimator</span><span class="o">.</span><span class="n">estimate_effect</span><span class="p">()</span>
            <span class="n">refute</span> <span class="o">=</span> <span class="n">CausalRefutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">new_effect</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                    <span class="n">refutation_type</span><span class="o">=</span><span class="s2">&quot;Refute: Add an Unobserved Common Cause&quot;</span><span class="p">)</span>

            <span class="n">refute</span><span class="o">.</span><span class="n">new_effect_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_effect</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">refute</span><span class="o">.</span><span class="n">new_effect</span> <span class="o">=</span> <span class="n">new_effect</span><span class="o">.</span><span class="n">value</span>
            <span class="n">refute</span><span class="o">.</span><span class="n">add_refuter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">refute</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># Deal with multiple value inputs</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span> <span class="c1"># Deal with range inputs</span>
                <span class="c1"># Get a 2D matrix of values</span>
                <span class="c1">#x,y =  np.meshgrid(self.kappa_t, self.kappa_y) # x,y are both MxN</span>

                <span class="n">results_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">))</span> <span class="c1"># Matrix to hold all the results of NxM</span>
                <span class="n">orig_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">)):</span>
                        <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_confounders_effect</span><span class="p">(</span><span class="n">orig_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">new_estimator</span> <span class="o">=</span> <span class="n">CausalEstimator</span><span class="o">.</span><span class="n">get_estimator_object</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="p">)</span>
                        <span class="n">new_effect</span> <span class="o">=</span> <span class="n">new_estimator</span><span class="o">.</span><span class="n">estimate_effect</span><span class="p">()</span>
                        <span class="n">refute</span> <span class="o">=</span> <span class="n">CausalRefutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">new_effect</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                                <span class="n">refutation_type</span><span class="o">=</span><span class="s2">&quot;Refute: Add an Unobserved Common Cause&quot;</span><span class="p">)</span>
                        <span class="n">results_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">refute</span><span class="o">.</span><span class="n">new_effect</span> <span class="c1"># Populate the results</span>

                <span class="n">refute</span><span class="o">.</span><span class="n">new_effect_array</span> <span class="o">=</span> <span class="n">results_matrix</span>
                <span class="n">refute</span><span class="o">.</span><span class="n">new_effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">results_matrix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">results_matrix</span><span class="p">))</span>
                <span class="c1"># Store the values into the refute object</span>
                <span class="n">refute</span><span class="o">.</span><span class="n">add_refuter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotmethod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">refute</span>

                <span class="kn">import</span> <span class="nn">matplotlib</span>
                <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
                <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">])</span>

                <span class="n">oe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="o">.</span><span class="n">value</span>
                <span class="n">contour_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">oe</span><span class="o">/</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">oe</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">oe</span><span class="p">,</span> <span class="n">oe</span><span class="p">]</span>
                <span class="n">contour_levels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">results_matrix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">results_matrix</span><span class="p">)])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotmethod</span><span class="o">==</span><span class="s2">&quot;contour&quot;</span><span class="p">:</span>
                    <span class="n">cp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">,</span> <span class="n">results_matrix</span><span class="p">,</span>
                            <span class="n">levels</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">))</span>
                    <span class="c1"># Adding a label on the contour line for the original estimate</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">trueeffect_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">levels</span><span class="o">==</span><span class="n">oe</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fmt</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">trueeffect_index</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;Estimated Effect&quot;</span>
                    <span class="c1"># Label every other level using strings</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cp</span><span class="p">,[</span><span class="n">cp</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">trueeffect_index</span><span class="p">]],</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotmethod</span><span class="o">==</span><span class="s2">&quot;colormesh&quot;</span><span class="p">:</span>
                    <span class="n">cp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">,</span> <span class="n">results_matrix</span><span class="p">,</span>
                            <span class="n">shading</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">contour_levels</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Effect of Unobserved Common Cause&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Value of Linear Constant on Treatment&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Value of Linear Constant on Outcome&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">refute</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">outcomes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">))</span>
                <span class="n">orig_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">)):</span>
                    <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_confounders_effect</span><span class="p">(</span><span class="n">orig_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">)</span>
                    <span class="n">new_estimator</span> <span class="o">=</span> <span class="n">CausalEstimator</span><span class="o">.</span><span class="n">get_estimator_object</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="p">)</span>
                    <span class="n">new_effect</span> <span class="o">=</span> <span class="n">new_estimator</span><span class="o">.</span><span class="n">estimate_effect</span><span class="p">()</span>
                    <span class="n">refute</span> <span class="o">=</span> <span class="n">CausalRefutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">new_effect</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                            <span class="n">refutation_type</span><span class="o">=</span><span class="s2">&quot;Refute: Add an Unobserved Common Cause&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">refute</span><span class="p">)</span>
                    <span class="n">outcomes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">refute</span><span class="o">.</span><span class="n">new_effect</span> <span class="c1"># Populate the results</span>

                <span class="n">refute</span><span class="o">.</span><span class="n">new_effect_array</span> <span class="o">=</span> <span class="n">outcomes</span>
                <span class="n">refute</span><span class="o">.</span><span class="n">new_effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">outcomes</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outcomes</span><span class="p">))</span>
                <span class="n">refute</span><span class="o">.</span><span class="n">add_refuter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotmethod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">refute</span>

                <span class="kn">import</span> <span class="nn">matplotlib</span>
                <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
                <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">])</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Effect of Unobserved Common Cause&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Value of Linear Constant on Treatment&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Estimated Effect after adding the common cause&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">refute</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">outcomes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">))</span>
                <span class="n">orig_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">)):</span>
                    <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_confounders_effect</span><span class="p">(</span><span class="n">orig_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">new_estimator</span> <span class="o">=</span> <span class="n">CausalEstimator</span><span class="o">.</span><span class="n">get_estimator_object</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_estimand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="p">)</span>
                    <span class="n">new_effect</span> <span class="o">=</span> <span class="n">new_estimator</span><span class="o">.</span><span class="n">estimate_effect</span><span class="p">()</span>
                    <span class="n">refute</span> <span class="o">=</span> <span class="n">CausalRefutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">new_effect</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                            <span class="n">refutation_type</span><span class="o">=</span><span class="s2">&quot;Refute: Add an Unobserved Common Cause&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">refute</span><span class="p">)</span>
                    <span class="n">outcomes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">refute</span><span class="o">.</span><span class="n">new_effect</span> <span class="c1"># Populate the results</span>

                <span class="n">refute</span><span class="o">.</span><span class="n">new_effect_array</span> <span class="o">=</span> <span class="n">outcomes</span>
                <span class="n">refute</span><span class="o">.</span><span class="n">new_effect</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">outcomes</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outcomes</span><span class="p">))</span>
                <span class="n">refute</span><span class="o">.</span><span class="n">add_refuter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotmethod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">refute</span>

                <span class="kn">import</span> <span class="nn">matplotlib</span>
                <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
                <span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">])</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span><span class="p">,</span> <span class="n">outcomes</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_estimate</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Effect of Unobserved Common Cause&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Value of Linear Constant on Outcome&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Estimated Effect after adding the common cause&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">refute</span></div>

<div class="viewcode-block" id="AddUnobservedCommonCause.include_confounders_effect"><a class="viewcode-back" href="../../../dowhy.causal_refuters.html#dowhy.causal_refuters.add_unobserved_common_cause.AddUnobservedCommonCause.include_confounders_effect">[docs]</a>    <span class="k">def</span> <span class="nf">include_confounders_effect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_data</span><span class="p">,</span> <span class="n">kappa_t</span><span class="p">,</span> <span class="n">kappa_y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function deals with the change in the value of the data due to the effect of the unobserved confounder.</span>
<span class="sd">        In the case of a binary flip, we flip only if the random number is greater than the threshold set.</span>
<span class="sd">        In the case of a linear effect, we use the variable as the linear regression constant.</span>

<span class="sd">        :param new_data: pandas.DataFrame: The data to be changed due to the effects of the unobserved confounder.</span>
<span class="sd">        :param kappa_t: numpy.float64: The value of the threshold for binary_flip or the value of the regression coefficient for linear effect.</span>
<span class="sd">        :param kappa_y: numpy.float64: The value of the threshold for binary_flip or the value of the regression coefficient for linear effect.</span>

<span class="sd">        :return: pandas.DataFrame: The DataFrame that includes the effects of the unobserved confounder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stdnorm</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
        <span class="n">w_random</span> <span class="o">=</span> <span class="n">stdnorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">num_rows</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_t</span> <span class="o">==</span> <span class="s2">&quot;binary_flip&quot;</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">kappa_t</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">kappa_t</span> <span class="o">&gt;=</span><span class="mf">0.5</span> <span class="k">else</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">kappa_t</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">stdnorm</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">rel_interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">kappa_t</span> <span class="o">&gt;=</span><span class="mf">0.5</span> <span class="k">else</span> <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rel_interval</span> <span class="o">&lt;=</span> <span class="n">w_random</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_treatment_name</span> <span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span> <span class="n">new_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rel_interval</span> <span class="o">&lt;=</span> <span class="n">w_random</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_treatment_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_treatment_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_bool_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">tname</span><span class="p">]):</span>
                    <span class="n">new_data</span> <span class="o">=</span> <span class="n">new_data</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">tname</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">},</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_t</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">confounder_t_effect</span> <span class="o">=</span> <span class="n">kappa_t</span> <span class="o">*</span> <span class="n">w_random</span>
            <span class="c1"># By default, we add the effect of simulated confounder for treatment.</span>
            <span class="c1"># But subtract it from outcome to create a negative correlation</span>
            <span class="c1"># assuming that the original confounder&#39;s effect was positive on both.</span>
            <span class="c1"># This is to remove the effect of the original confounder.</span>
            <span class="n">new_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_treatment_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_treatment_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">confounder_t_effect</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_t</span> <span class="o">+</span> <span class="s2">&quot;&#39; method not supported for confounders&#39; effect on treatment&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_y</span> <span class="o">==</span> <span class="s2">&quot;binary_flip&quot;</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">kappa_y</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">kappa_y</span> <span class="o">&gt;=</span><span class="mf">0.5</span> <span class="k">else</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">kappa_y</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">stdnorm</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">rel_interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">kappa_y</span> <span class="o">&gt;=</span><span class="mf">0.5</span> <span class="k">else</span> <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rel_interval</span> <span class="o">&lt;=</span> <span class="n">w_random</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outcome_name</span> <span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span> <span class="n">new_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rel_interval</span> <span class="o">&lt;=</span> <span class="n">w_random</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outcome_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">yname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outcome_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_bool_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">yname</span><span class="p">]):</span>
                    <span class="n">new_data</span> <span class="o">=</span> <span class="n">new_data</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">yname</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">},</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_y</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">confounder_y_effect</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">kappa_y</span> <span class="o">*</span> <span class="n">w_random</span>
            <span class="c1"># By default, we add the effect of simulated confounder for treatment.</span>
            <span class="c1"># But subtract it from outcome to create a negative correlation</span>
            <span class="c1"># assuming that the original confounder&#39;s effect was positive on both.</span>
            <span class="c1"># This is to remove the effect of the original confounder.</span>
            <span class="n">new_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_outcome_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_outcome_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">confounder_y_effect</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">effect_on_y</span><span class="o">+</span> <span class="s2">&quot;&#39; method not supported for confounders&#39; effect on outcome&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_data</span></div>



<div class="viewcode-block" id="AddUnobservedCommonCause.include_simulated_confounder"><a class="viewcode-back" href="../../../dowhy.causal_refuters.html#dowhy.causal_refuters.add_unobserved_common_cause.AddUnobservedCommonCause.include_simulated_confounder">[docs]</a>    <span class="k">def</span> <span class="nf">include_simulated_confounder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">convergence_threshold</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">c_star_max</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This function simulates an unobserved confounder based on the data using the following steps:</span>
<span class="sd">        1. It calculates the &quot;residuals&quot;  from the treatment and outcome model</span>
<span class="sd">        i.) The outcome model has outcome as the dependent variable and all the observed variables including treatment as independent variables</span>
<span class="sd">        ii.) The treatment model has treatment as the dependent variable and all the observed variables as independent variables.</span>

<span class="sd">        2. U is an intermediate random variable drawn from the normal distribution with the weighted average of residuals as mean and a unit variance</span>
<span class="sd">        U ~ N(c1*d_y + c2*d_t, 1)</span>
<span class="sd">        where</span>
<span class="sd">        *d_y and d_t are residuals from the treatment and outcome model</span>
<span class="sd">        *c1 and c2 are coefficients to the residuals</span>

<span class="sd">        3. The final U, which is the simulated unobserved confounder is obtained by debiasing the intermediate variable U by residualising it with X</span>


<span class="sd">        Choosing the coefficients c1 and c2:</span>
<span class="sd">        The coefficients are chosen based on these basic assumptions:</span>
<span class="sd">        1. There is a hyperbolic relationship satisfying c1*c2 = c_star</span>
<span class="sd">        2. c_star is chosen from a range of possible values based on the correlation of the obtained simulated variable with outcome and treatment.</span>
<span class="sd">        3. The product of correlations with treatment and outcome should be at a minimum distance to the maximum correlations with treatment and outcome in any of the observed confounders</span>
<span class="sd">        4. The ratio of the weights should be such that they maintain the ratio of the maximum possible observed coefficients within some confidence interval</span>

<span class="sd">        :param c_star_max: The maximum possible value for the hyperbolic curve on which the coefficients to the residuals lie. It defaults to 1000 in the code if not specified by the user.</span>
<span class="sd">            :type int</span>
<span class="sd">        :param convergence_threshold: The threshold to check the plateauing of the correlation while selecting a c_star. It defaults to 0.1 in the code if not specified by the user</span>
<span class="sd">            :type float</span>

<span class="sd">        :returns: The simulated values of the unobserved confounder based on the data</span>
<span class="sd">            :type pandas.core.series.Series</span>

<span class="sd">        &#39;&#39;&#39;</span>


        <span class="c1">#Obtaining the list of observed variables</span>
        <span class="n">required_variables</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">observed_variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_variables</span><span class="p">(</span><span class="n">required_variables</span><span class="p">)</span>

        <span class="n">observed_variables_with_treatment_and_outcome</span> <span class="o">=</span> <span class="n">observed_variables</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_treatment_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outcome_name</span>

        <span class="c1">#Taking a subset of the dataframe that has only observed variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">observed_variables_with_treatment_and_outcome</span><span class="p">]</span>

        <span class="c1">#Residuals from the outcome model obtained by fitting a linear model</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_outcome_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">observed_variables_with_treatment</span> <span class="o">=</span> <span class="n">observed_variables</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_treatment_name</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">observed_variables_with_treatment</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">residuals_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">results</span><span class="o">.</span><span class="n">fittedvalues</span>
        <span class="n">d_y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">residuals_y</span><span class="p">))</span>


        <span class="c1">#Residuals from the treatment model obtained by fitting a linear model</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_treatment_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">observed_variables</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">X</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">residuals_t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">results</span><span class="o">.</span><span class="n">fittedvalues</span>
        <span class="n">d_t</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">residuals_t</span><span class="p">))</span>


        <span class="c1">#Initialising product_cor_metric_observed with a really low value as finding maximum</span>
        <span class="n">product_cor_metric_observed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000000000</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">observed_variables</span><span class="p">:</span>
            <span class="n">current_obs_confounder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">outcome_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_outcome_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">correlation_y</span> <span class="o">=</span> <span class="n">current_obs_confounder</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">outcome_values</span><span class="p">)</span>
            <span class="n">treatment_values</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">correlation_t</span> <span class="o">=</span> <span class="n">current_obs_confounder</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">treatment_values</span><span class="p">)</span>
            <span class="n">product_cor_metric_current</span> <span class="o">=</span> <span class="n">correlation_y</span><span class="o">*</span><span class="n">correlation_t</span>
            <span class="k">if</span> <span class="n">product_cor_metric_current</span><span class="o">&gt;=</span><span class="n">product_cor_metric_observed</span><span class="p">:</span>
                <span class="n">product_cor_metric_observed</span> <span class="o">=</span> <span class="n">product_cor_metric_current</span>
                <span class="n">correlation_t_observed</span> <span class="o">=</span> <span class="n">correlation_t</span>
                <span class="n">correlation_y_observed</span> <span class="o">=</span> <span class="n">correlation_y</span>


        <span class="c1">#The user has an option to give the the effect_strength_on_y and effect_strength_on_t which can be then used instead of maximum correlation with treatment and outcome in the observed variables as it specifies the desired effect.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">correlation_t_observed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_t</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">correlation_y_observed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_y</span>


        <span class="c1">#Choosing a c_star based on the data.</span>
        <span class="c1">#The correlations stop increasing upon increasing c_star after a certain value, that is it plateaus and we choose the value of c_star to be the value it plateaus.</span>

        <span class="n">correlation_y_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">correlation_t_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">product_cor_metric_simulated_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x_list</span> <span class="o">=</span> <span class="p">[]</span>


        <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_star_max</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_star_max</span><span class="p">),</span> <span class="n">step</span><span class="p">):</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">c1</span>
            <span class="n">final_U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_confounder_from_residuals</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">d_y</span><span class="p">,</span> <span class="n">d_t</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
            <span class="n">current_simulated_confounder</span> <span class="o">=</span> <span class="n">final_U</span>
            <span class="n">outcome_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_outcome_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">correlation_y</span> <span class="o">=</span> <span class="n">current_simulated_confounder</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">outcome_values</span><span class="p">)</span>
            <span class="n">correlation_y_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation_y</span><span class="p">)</span>

            <span class="n">treatment_values</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">correlation_t</span> <span class="o">=</span> <span class="n">current_simulated_confounder</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">treatment_values</span><span class="p">)</span>
            <span class="n">correlation_t_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation_t</span><span class="p">)</span>

            <span class="n">product_cor_metric_simulated</span> <span class="o">=</span> <span class="n">correlation_y</span><span class="o">*</span><span class="n">correlation_t</span>
            <span class="n">product_cor_metric_simulated_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">product_cor_metric_simulated</span><span class="p">)</span>


            <span class="n">x_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


        <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">index</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">correlation_y_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">correlation_y_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-</span><span class="n">correlation_y_list</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">convergence_threshold</span><span class="p">:</span>
                <span class="n">c_star</span> <span class="o">=</span> <span class="n">x_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span>

        <span class="c1">#Choosing c1 and c2 based on the hyperbolic relationship once c_star is chosen by going over various combinations of c1 and c2 values and choosing the combination which</span>
        <span class="c1">#which maintains the minimum distance between the product of correlations of the simulated variable and the product of maximum correlations of one of the observed variables</span>
        <span class="c1"># and additionally checks if the ratio of the weights are such that they maintain the ratio of the maximum possible observed coefficients within some confidence interval</span>


        <span class="c1">#c1_final and c2_final are initialised to the values on the hyperbolic curve such that c1_final = c2_final  and c1_final*c2_final = c_star</span>
        <span class="n">c1_final</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c_star</span><span class="p">)</span>
        <span class="n">c2_final</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c_star</span><span class="p">)</span>


        <span class="c1">#initialising min_distance_between_product_cor_metrics to be a value greater than 1</span>
        <span class="n">min_distance_between_product_cor_metrics</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mf">0.05</span>

        <span class="n">threshold</span> <span class="o">=</span> <span class="n">c_star</span><span class="o">/</span><span class="mf">0.05</span>

        <span class="k">while</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">threshold</span><span class="p">:</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c_star</span><span class="o">/</span><span class="n">c2</span>
            <span class="n">final_U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_confounder_from_residuals</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">d_y</span><span class="p">,</span> <span class="n">d_t</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

            <span class="n">current_simulated_confounder</span> <span class="o">=</span> <span class="n">final_U</span>
            <span class="n">outcome_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_outcome_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">correlation_y</span> <span class="o">=</span> <span class="n">current_simulated_confounder</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">outcome_values</span><span class="p">)</span>

            <span class="n">treatment_values</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">correlation_t</span> <span class="o">=</span> <span class="n">current_simulated_confounder</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">treatment_values</span><span class="p">)</span>

            <span class="n">product_cor_metric_simulated</span> <span class="o">=</span> <span class="n">correlation_y</span><span class="o">*</span><span class="n">correlation_t</span>

            <span class="k">if</span> <span class="n">min_distance_between_product_cor_metrics</span><span class="o">&gt;=</span><span class="nb">abs</span><span class="p">(</span><span class="n">product_cor_metric_simulated</span> <span class="o">-</span> <span class="n">product_cor_metric_observed</span><span class="p">):</span>
                <span class="n">min_distance_between_product_cor_metrics</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">product_cor_metric_simulated</span> <span class="o">-</span> <span class="n">product_cor_metric_observed</span><span class="p">)</span>
                <span class="n">additional_condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">correlation_y_observed</span><span class="o">/</span><span class="n">correlation_t_observed</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">c1</span><span class="o">/</span><span class="n">c2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">additional_condition</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">additional_condition</span><span class="p">))</span> <span class="ow">and</span> <span class="p">((</span><span class="n">c1</span><span class="o">/</span><span class="n">c2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">additional_condition</span> <span class="o">-</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">additional_condition</span><span class="p">)):</span> <span class="c1">#choose minimum positive value</span>
                    <span class="n">c1_final</span> <span class="o">=</span> <span class="n">c1</span>
                    <span class="n">c2_final</span> <span class="o">=</span> <span class="n">c2</span>

            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="mf">1.5</span>

        <span class="sd">&#39;&#39;&#39;#closed form solution</span>

<span class="sd">        print(&quot;c_star_max before closed form&quot;, c_star_max)</span>

<span class="sd">        if max_correlation_with_t == -1000:</span>
<span class="sd">            c2 = 0</span>
<span class="sd">            c1 = c_star_max</span>
<span class="sd">        else:</span>
<span class="sd">            additional_condition = abs(max_correlation_with_y/max_correlation_with_t)</span>
<span class="sd">            print(&quot;additional_condition&quot;, additional_condition)</span>
<span class="sd">            c2 = math.sqrt(c_star_max/additional_condition)</span>
<span class="sd">            c1 = c_star_max/c2&#39;&#39;&#39;</span>

        <span class="n">final_U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_confounder_from_residuals</span><span class="p">(</span><span class="n">c1_final</span><span class="p">,</span> <span class="n">c2_final</span><span class="p">,</span> <span class="n">d_y</span><span class="p">,</span> <span class="n">d_t</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_U</span></div>


<div class="viewcode-block" id="AddUnobservedCommonCause.generate_confounder_from_residuals"><a class="viewcode-back" href="../../../dowhy.causal_refuters.html#dowhy.causal_refuters.add_unobserved_common_cause.AddUnobservedCommonCause.generate_confounder_from_residuals">[docs]</a>    <span class="k">def</span> <span class="nf">generate_confounder_from_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">d_y</span><span class="p">,</span> <span class="n">d_t</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This function takes the residuals from the treatment and outcome model and their coefficients and simulates the intermediate random variable U by taking</span>
<span class="sd">        the row wise normal distribution corresponding to each residual value and then debiasing the intermediate variable to get the final variable.</span>

<span class="sd">        :param c1: coefficient to the residual from the outcome model</span>
<span class="sd">        :type float</span>
<span class="sd">        :param c2: coefficient to the residual from the treatment model</span>
<span class="sd">        :type float</span>
<span class="sd">        :param d_y: residuals from the outcome model</span>
<span class="sd">        :type list</span>
<span class="sd">        :param d_t: residuals from the treatment model</span>
<span class="sd">        :type list</span>

<span class="sd">        :returns: The simulated values of the unobserved confounder based on the data</span>
<span class="sd">        :type pandas.core.series.Series</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">U</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_t</span><span class="p">)):</span>
            <span class="n">simulated_variable_mean</span> <span class="o">=</span> <span class="n">c1</span><span class="o">*</span><span class="n">d_y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">c2</span><span class="o">*</span><span class="n">d_t</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">simulated_variable_stddev</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">U</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">simulated_variable_mean</span><span class="p">,</span> <span class="n">simulated_variable_stddev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">X</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span>
        <span class="n">final_U</span> <span class="o">=</span> <span class="n">U</span> <span class="o">-</span> <span class="n">results</span><span class="o">.</span><span class="n">fittedvalues</span><span class="o">.</span><span class="n">values</span>
        <span class="n">final_U</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_U</span></div></div>









</pre></div>

              </article>
              

              
              <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              </footer>
              
          </div>
          
      </div>
    </div>

  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695"></script>

<footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    <p class="copyright">
    &copy; Copyright 2022, PyWhy contributors.<br>
</p>
  </div>
  
  <div class="footer-item">
    <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.0.2.<br>
</p>
  </div>
  
</div>
</footer>
  </body>
</html>