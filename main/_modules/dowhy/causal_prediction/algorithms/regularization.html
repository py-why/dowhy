
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B139P18WHM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-B139P18WHM');
    </script>
    
    <title>dowhy.causal_prediction.algorithms.regularization &#8212; DoWhy  documentation</title>
<script>
  document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
  document.documentElement.dataset.theme = localStorage.getItem("theme") || "light"
</script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=92025949c220c2e29695" rel="stylesheet">
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=92025949c220c2e29695" rel="stylesheet">


  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695">

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/design-tabs.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">
    <div class="bd-header-announcement container-fluid" id="banner">
      

    </div>

    
    <nav class="bd-header navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="bd-header__inner container-xl">

  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
    <img src="../../../../_static/dowhy-logo-small.png" class="logo__image only-light" alt="Logo image">
    <img src="../../../../_static/dowhy-logo-small.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="fas fa-bars"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../getting_started/index.html">
  Getting Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../user_guide/index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../example_notebooks/nb_index.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../dowhy.html">
  dowhy package
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../contributing.html">
  Contributing
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../code_repo.html">
  Release notes
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../../cite.html">
  Citing this package
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        main
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
        <dl>
            <dt>Releases</dt>
            <dd><a href="/dowhy/v0.9.1/index.html">v0.9.1</a></dd>
            <dd><a href="/dowhy/v0.9/index.html">v0.9</a></dd>
            <dd><a href="/dowhy/v0.8/index.html">v0.8</a></dd>
            <dd><a href="/dowhy/v0.7.1/index.html">v0.7.1</a></dd>
            <dd><a href="/dowhy/v0.7/index.html">v0.7</a></dd>
            <dd><a href="/dowhy/v0.6/index.html">v0.6</a></dd>
            <dd><a href="/dowhy/v0.5.1/index.html">v0.5.1</a></dd>
            <dd><a href="/dowhy/v0.5/index.html">v0.5</a></dd>
            <dd><a href="/dowhy/v0.4/index.html">v0.4</a></dd>
            <dd><a href="/dowhy/v0.2/index.html">v0.2</a></dd>
            <dd><a href="/dowhy/v0.1.1-alpha/index.html">v0.1.1-alpha</a></dd>
        </dl>        
        <dl>
            <dt>Branches</dt>
            <dd><a href="">main</a></dd>
        </dl>        
    </div>
</div>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="bd-container container-xl">
      <div class="bd-container__inner row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="bd-sidebar-primary col-12 col-md-3 bd-sidebar">
  <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
  </div>
  <div class="sidebar-end-items">
  </div>
</div>


          


<div class="bd-sidebar-secondary d-none d-xl-block col-xl-2 bd-toc">
  
</div>


          
          
          <div class="bd-content col-12 col-md-9 col-xl-7">
              
              <article class="bd-article" role="main">
                
  <h1>Source code for dowhy.causal_prediction.algorithms.regularization</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>

<span class="kn">from</span> <span class="nn">dowhy.causal_prediction.algorithms.utils</span> <span class="kn">import</span> <span class="n">mmd_compute</span>


<div class="viewcode-block" id="Regularizer"><a class="viewcode-back" href="../../../../dowhy.causal_prediction.algorithms.html#dowhy.causal_prediction.algorithms.regularization.Regularizer">[docs]</a><span class="k">class</span> <span class="nc">Regularizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements methods for applying unconditional and conditional regularization.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">E_conditioned</span><span class="p">,</span>
        <span class="n">ci_test</span><span class="p">,</span>
        <span class="n">kernel_type</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param E_conditioned: Binary flag indicating whether E-conditioned regularization has to be applied</span>
<span class="sd">        :param ci_test: Conditional independence metric used for regularization penalty. Currently, MMD is supported.</span>
<span class="sd">        :param kernel_type: Kernel type for MMD penalty. Currently, supports &quot;gaussian&quot; (RBF). If None, distance between mean and second-order statistics (covariances) is used.</span>
<span class="sd">        :param gamma: kernel bandwidth for MMD (due to implementation, the kernel bandwdith will actually be the reciprocal of gamma i.e., gamma=1e-6 implies kernel bandwidth=1e6. See `mmd_compute` in utils.py)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">E_conditioned</span> <span class="o">=</span> <span class="n">E_conditioned</span>  <span class="c1"># E-conditioned regularization by default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ci_test</span> <span class="o">=</span> <span class="n">ci_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_type</span> <span class="o">=</span> <span class="n">kernel_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>

<div class="viewcode-block" id="Regularizer.mmd"><a class="viewcode-back" href="../../../../dowhy.causal_prediction.algorithms.html#dowhy.causal_prediction.algorithms.regularization.Regularizer.mmd">[docs]</a>    <span class="k">def</span> <span class="nf">mmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute MMD penalty between x and y.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">mmd_compute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span></div>

<div class="viewcode-block" id="Regularizer.unconditional_reg"><a class="viewcode-back" href="../../../../dowhy.causal_prediction.algorithms.html#dowhy.causal_prediction.algorithms.regularization.Regularizer.unconditional_reg">[docs]</a>    <span class="k">def</span> <span class="nf">unconditional_reg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifs</span><span class="p">,</span> <span class="n">attribute_labels</span><span class="p">,</span> <span class="n">num_envs</span><span class="p">,</span> <span class="n">E_eq_A</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implement unconditional regularization φ(x) ⊥⊥ A_i</span>

<span class="sd">        :param classifs: feature representations output from classifier layer (gφ(x))</span>
<span class="sd">        :param attribute_labels: attribute labels loaded with the dataset for attribute A_i</span>
<span class="sd">        :param num_envs: number of environments/domains</span>
<span class="sd">        :param E_eq_A: Binary flag indicating whether attribute (A_i) coinicides with environment (E) definition</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">penalty</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">E_eq_A</span><span class="p">:</span>  <span class="c1"># Environment (E) and attribute (A) coincide</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_conditioned</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># there is no correlation between E and X_c</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_envs</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_envs</span><span class="p">):</span>
                        <span class="n">penalty</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmd</span><span class="p">(</span><span class="n">classifs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">classifs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_conditioned</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_envs</span><span class="p">):</span>
                    <span class="n">unique_attr_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">attribute_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">unique_attr_label_indices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">unique_attr_labels</span><span class="p">:</span>
                        <span class="n">label_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">ind</span> <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attribute_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>
                        <span class="n">unique_attr_label_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_ind</span><span class="p">)</span>

                    <span class="n">nulabels</span> <span class="o">=</span> <span class="n">unique_attr_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">aidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nulabels</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">bidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nulabels</span><span class="p">):</span>
                            <span class="n">penalty</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmd</span><span class="p">(</span>
                                <span class="n">classifs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">unique_attr_label_indices</span><span class="p">[</span><span class="n">aidx</span><span class="p">]],</span>
                                <span class="n">classifs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">unique_attr_label_indices</span><span class="p">[</span><span class="n">bidx</span><span class="p">]],</span>
                            <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># this currently assumes we have a disjoint set of attributes (Aind) across environments i.e., environment is defined by multiple closely related values of the attribute</span>
                <span class="n">overall_nmb_indices</span><span class="p">,</span> <span class="n">nmb_id</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_envs</span><span class="p">):</span>
                    <span class="n">unique_attrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">attribute_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">unique_attr_indices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">unique_attrs</span><span class="p">:</span>
                        <span class="n">attr_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">ind</span> <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attribute_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">attr</span><span class="p">]</span>
                        <span class="n">unique_attr_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr_ind</span><span class="p">)</span>
                        <span class="n">overall_nmb_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr_ind</span><span class="p">)</span>
                        <span class="n">nmb_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="n">nuattr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">overall_nmb_indices</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">aidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nuattr</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">bidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nuattr</span><span class="p">):</span>
                        <span class="n">a_nmb_id</span> <span class="o">=</span> <span class="n">nmb_id</span><span class="p">[</span><span class="n">aidx</span><span class="p">]</span>
                        <span class="n">b_nmb_id</span> <span class="o">=</span> <span class="n">nmb_id</span><span class="p">[</span><span class="n">bidx</span><span class="p">]</span>
                        <span class="n">penalty</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmd</span><span class="p">(</span>
                            <span class="n">classifs</span><span class="p">[</span><span class="n">a_nmb_id</span><span class="p">][</span><span class="n">overall_nmb_indices</span><span class="p">[</span><span class="n">aidx</span><span class="p">]],</span>
                            <span class="n">classifs</span><span class="p">[</span><span class="n">b_nmb_id</span><span class="p">][</span><span class="n">overall_nmb_indices</span><span class="p">[</span><span class="n">bidx</span><span class="p">]],</span>
                        <span class="p">)</span>

        <span class="k">return</span> <span class="n">penalty</span></div>

<div class="viewcode-block" id="Regularizer.conditional_reg"><a class="viewcode-back" href="../../../../dowhy.causal_prediction.algorithms.html#dowhy.causal_prediction.algorithms.regularization.Regularizer.conditional_reg">[docs]</a>    <span class="k">def</span> <span class="nf">conditional_reg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classifs</span><span class="p">,</span> <span class="n">attribute_labels</span><span class="p">,</span> <span class="n">conditioning_subset</span><span class="p">,</span> <span class="n">num_envs</span><span class="p">,</span> <span class="n">E_eq_A</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implement conditional regularization φ(x) ⊥⊥ A_i | A_s</span>

<span class="sd">        :param classifs: feature representations output from classifier layer (gφ(x))</span>
<span class="sd">        :param attribute_labels: attribute labels loaded with the dataset for attribute A_i</span>
<span class="sd">        :param conditioning_subset: list of subset of observed variables A_s (attributes + targets) such that (X_c, A_i) are d-separated conditioned on this subset</span>
<span class="sd">        :param num_envs: number of environments/domains</span>
<span class="sd">        :param E_eq_A: Binary flag indicating whether attribute (A_i) coinicides with environment (E) definition</span>

<span class="sd">        Find group indices for conditional regularization based on conditioning subset by taking all possible combinations</span>
<span class="sd">        e.g., conditioning_subset = [A1, Y], where A1 is in {0, 1} and Y is in {0, 1, 2},</span>
<span class="sd">        we assign groups in the following way:</span>
<span class="sd">            A1 = 0, Y = 0 -&gt; group 0</span>
<span class="sd">            A1 = 1, Y = 0 -&gt; group 1</span>
<span class="sd">            A1 = 0, Y = 1 -&gt; group 2</span>
<span class="sd">            A1 = 1, Y = 1 -&gt; group 3</span>
<span class="sd">            A1 = 0, Y = 2 -&gt; group 4</span>
<span class="sd">            A1 = 1, Y = 2 -&gt; group 5</span>

<span class="sd">        Code snippet for computing group indices adapted from WILDS: https://github.com/p-lambda/wilds</span>
<span class="sd">            @inproceedings{wilds2021,</span>
<span class="sd">             title = {{WILDS}: A Benchmark of in-the-Wild Distribution Shifts},</span>
<span class="sd">             author = {Pang Wei Koh and Shiori Sagawa and Henrik Marklund and Sang Michael Xie and Marvin Zhang and Akshay Balsubramani and Weihua Hu and Michihiro Yasunaga and Richard Lanas Phillips and Irena Gao and Tony Lee and Etienne David and Ian Stavness and Wei Guo and Berton A. Earnshaw and Imran S. Haque and Sara Beery and Jure Leskovec and Anshul Kundaje and Emma Pierson and Sergey Levine and Chelsea Finn and Percy Liang},</span>
<span class="sd">             booktitle = {International Conference on Machine Learning (ICML)},</span>
<span class="sd">             year = {2021}</span>
<span class="sd">            }`</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">penalty</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">E_eq_A</span><span class="p">:</span>  <span class="c1"># Environment (E) and attribute (A) coincide</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_conditioned</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># there is no correlation between E and X_c</span>
                <span class="n">overall_group_vindices</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># storing group indices</span>
                <span class="n">overall_group_eindices</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># storing corresponding environment indices</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_envs</span><span class="p">):</span>
                    <span class="n">conditioning_subset_i</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">subset_var</span> <span class="ow">in</span> <span class="n">conditioning_subset</span><span class="p">]</span>
                    <span class="n">conditioning_subset_i_uniform</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">ele</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">ele</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ele</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">conditioning_subset_i</span>
                    <span class="p">]</span>
                    <span class="n">grouping_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">conditioning_subset_i_uniform</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">grouping_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Group numbers cannot be negative.&quot;</span>
                    <span class="n">cardinality</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grouping_data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">cumprod</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">cardinality</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">n_groups</span> <span class="o">=</span> <span class="n">cumprod</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="n">factors_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">1</span><span class="p">],</span> <span class="n">cumprod</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">factors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">factors_np</span><span class="p">)</span>
                    <span class="n">group_indices</span> <span class="o">=</span> <span class="n">grouping_data</span> <span class="o">@</span> <span class="n">factors</span>

                    <span class="k">for</span> <span class="n">group_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_groups</span><span class="p">):</span>
                        <span class="n">group_idx_indices</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">gp_idx</span> <span class="k">for</span> <span class="n">gp_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_indices</span><span class="p">))</span> <span class="k">if</span> <span class="n">group_indices</span><span class="p">[</span><span class="n">gp_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">group_idx</span>
                        <span class="p">]</span>

                        <span class="k">if</span> <span class="n">group_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">overall_group_vindices</span><span class="p">:</span>
                            <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">overall_group_eindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                        <span class="n">unique_attrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                            <span class="n">attribute_labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">group_idx_indices</span><span class="p">]</span>
                        <span class="p">)</span>  <span class="c1"># find distinct attributes in environment with same group_idx_indices</span>
                        <span class="n">unique_attr_indices</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">unique_attrs</span><span class="p">:</span>  <span class="c1"># storing indices with same attribute value and group label</span>
                            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">]:</span>
                                <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">overall_group_eindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">single_attr</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">group_idx_indices_attr</span> <span class="ow">in</span> <span class="n">group_idx_indices</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">attribute_labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">group_idx_indices_attr</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr</span><span class="p">:</span>
                                    <span class="n">single_attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_idx_indices_attr</span><span class="p">)</span>
                            <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_attr</span><span class="p">)</span>
                            <span class="n">overall_group_eindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="n">unique_attr_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_attr</span><span class="p">)</span>

                <span class="k">for</span> <span class="p">(</span>
                    <span class="n">group_label</span>
                <span class="p">)</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="n">overall_group_vindices</span>
                <span class="p">):</span>  <span class="c1"># applying MMD penalty between distributions P(φ(x)|ai, g), P(φ(x)|aj, g) i.e samples with different attribute labelues but same group label</span>
                    <span class="n">tensors_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_label</span><span class="p">]:</span>
                        <span class="n">attrs_list</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_label</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                            <span class="k">for</span> <span class="n">il_ind</span><span class="p">,</span> <span class="n">indices_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_label</span><span class="p">][</span><span class="n">attr</span><span class="p">]):</span>
                                <span class="n">attrs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">classifs</span><span class="p">[</span><span class="n">overall_group_eindices</span><span class="p">[</span><span class="n">group_label</span><span class="p">][</span><span class="n">attr</span><span class="p">][</span><span class="n">il_ind</span><span class="p">]][</span><span class="n">indices_list</span><span class="p">]</span>
                                <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">tensor_attrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">attrs_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">tensors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor_attrs</span><span class="p">)</span>

                    <span class="n">nuattr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensors_list</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">aidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nuattr</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">bidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nuattr</span><span class="p">):</span>
                            <span class="n">penalty</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmd</span><span class="p">(</span><span class="n">tensors_list</span><span class="p">[</span><span class="n">aidx</span><span class="p">],</span> <span class="n">tensors_list</span><span class="p">[</span><span class="n">bidx</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_conditioned</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_envs</span><span class="p">):</span>
                    <span class="n">conditioning_subset_i</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">subset_var</span> <span class="ow">in</span> <span class="n">conditioning_subset</span><span class="p">]</span>
                    <span class="n">conditioning_subset_i_uniform</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">ele</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">ele</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ele</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">conditioning_subset_i</span>
                    <span class="p">]</span>
                    <span class="n">grouping_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">conditioning_subset_i_uniform</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">grouping_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Group numbers cannot be negative.&quot;</span>
                    <span class="n">cardinality</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grouping_data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">cumprod</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">cardinality</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">n_groups</span> <span class="o">=</span> <span class="n">cumprod</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="n">factors_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">1</span><span class="p">],</span> <span class="n">cumprod</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">factors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">factors_np</span><span class="p">)</span>
                    <span class="n">group_indices</span> <span class="o">=</span> <span class="n">grouping_data</span> <span class="o">@</span> <span class="n">factors</span>

                    <span class="k">for</span> <span class="n">group_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_groups</span><span class="p">):</span>
                        <span class="n">group_idx_indices</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">gp_idx</span> <span class="k">for</span> <span class="n">gp_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_indices</span><span class="p">))</span> <span class="k">if</span> <span class="n">group_indices</span><span class="p">[</span><span class="n">gp_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">group_idx</span>
                        <span class="p">]</span>
                        <span class="n">unique_attrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                            <span class="n">attribute_labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">group_idx_indices</span><span class="p">]</span>
                        <span class="p">)</span>  <span class="c1"># find distinct attributes in environment with same group_idx_indices</span>
                        <span class="n">unique_attr_indices</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">unique_attrs</span><span class="p">:</span>
                            <span class="n">single_attr</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">group_idx_indices_attr</span> <span class="ow">in</span> <span class="n">group_idx_indices</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">attribute_labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">group_idx_indices_attr</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr</span><span class="p">:</span>
                                    <span class="n">single_attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_idx_indices_attr</span><span class="p">)</span>
                            <span class="n">unique_attr_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_attr</span><span class="p">)</span>

                        <span class="n">nuattr</span> <span class="o">=</span> <span class="n">unique_attrs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">aidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nuattr</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">bidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nuattr</span><span class="p">):</span>
                                <span class="n">penalty</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmd</span><span class="p">(</span>
                                    <span class="n">classifs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">unique_attr_indices</span><span class="p">[</span><span class="n">aidx</span><span class="p">]],</span> <span class="n">classifs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">unique_attr_indices</span><span class="p">[</span><span class="n">bidx</span><span class="p">]]</span>
                                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">overall_group_vindices</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># storing group indices</span>
                <span class="n">overall_group_eindices</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># storing corresponding environment indices</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_envs</span><span class="p">):</span>
                    <span class="n">conditioning_subset_i</span> <span class="o">=</span> <span class="p">[</span><span class="n">subset_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">subset_var</span> <span class="ow">in</span> <span class="n">conditioning_subset</span><span class="p">]</span>
                    <span class="n">conditioning_subset_i_uniform</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">ele</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">ele</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ele</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">conditioning_subset_i</span>
                    <span class="p">]</span>
                    <span class="n">grouping_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">conditioning_subset_i_uniform</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">grouping_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Group numbers cannot be negative.&quot;</span>
                    <span class="n">cardinality</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">grouping_data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">cumprod</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">cardinality</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">n_groups</span> <span class="o">=</span> <span class="n">cumprod</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="n">factors_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">1</span><span class="p">],</span> <span class="n">cumprod</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">factors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">factors_np</span><span class="p">)</span>
                    <span class="n">group_indices</span> <span class="o">=</span> <span class="n">grouping_data</span> <span class="o">@</span> <span class="n">factors</span>

                    <span class="k">for</span> <span class="n">group_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_groups</span><span class="p">):</span>
                        <span class="n">group_idx_indices</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">gp_idx</span> <span class="k">for</span> <span class="n">gp_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group_indices</span><span class="p">))</span> <span class="k">if</span> <span class="n">group_indices</span><span class="p">[</span><span class="n">gp_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">group_idx</span>
                        <span class="p">]</span>

                        <span class="k">if</span> <span class="n">group_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">overall_group_vindices</span><span class="p">:</span>
                            <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">overall_group_eindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                        <span class="n">unique_attrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                            <span class="n">attribute_labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">group_idx_indices</span><span class="p">]</span>
                        <span class="p">)</span>  <span class="c1"># find distinct attributes in environment with same group_idx_indices</span>
                        <span class="n">unique_attr_indices</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">unique_attrs</span><span class="p">:</span>  <span class="c1"># storing indices with same attribute value and group label</span>
                            <span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">]:</span>
                                <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">overall_group_eindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">single_attr</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">group_idx_indices_attr</span> <span class="ow">in</span> <span class="n">group_idx_indices</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">attribute_labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">group_idx_indices_attr</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr</span><span class="p">:</span>
                                    <span class="n">single_attr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_idx_indices_attr</span><span class="p">)</span>
                            <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_attr</span><span class="p">)</span>
                            <span class="n">overall_group_eindices</span><span class="p">[</span><span class="n">group_idx</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="n">unique_attr_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_attr</span><span class="p">)</span>

                <span class="k">for</span> <span class="p">(</span>
                    <span class="n">group_label</span>
                <span class="p">)</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="n">overall_group_vindices</span>
                <span class="p">):</span>  <span class="c1"># applying MMD penalty between distributions P(φ(x)|ai, g), P(φ(x)|aj, g) i.e samples with different attribute labelues but same group label</span>
                    <span class="n">tensors_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_label</span><span class="p">]:</span>
                        <span class="n">attrs_list</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_label</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]:</span>
                            <span class="k">for</span> <span class="n">il_ind</span><span class="p">,</span> <span class="n">indices_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">overall_group_vindices</span><span class="p">[</span><span class="n">group_label</span><span class="p">][</span><span class="n">attr</span><span class="p">]):</span>
                                <span class="n">attrs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">classifs</span><span class="p">[</span><span class="n">overall_group_eindices</span><span class="p">[</span><span class="n">group_label</span><span class="p">][</span><span class="n">attr</span><span class="p">][</span><span class="n">il_ind</span><span class="p">]][</span><span class="n">indices_list</span><span class="p">]</span>
                                <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">tensor_attrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">attrs_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">tensors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tensor_attrs</span><span class="p">)</span>

                    <span class="n">nuattr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensors_list</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">aidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nuattr</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">bidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nuattr</span><span class="p">):</span>
                            <span class="n">penalty</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmd</span><span class="p">(</span><span class="n">tensors_list</span><span class="p">[</span><span class="n">aidx</span><span class="p">],</span> <span class="n">tensors_list</span><span class="p">[</span><span class="n">bidx</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">penalty</span></div></div>
</pre></div>

              </article>
              

              
              <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              </footer>
              
          </div>
          
      </div>
    </div>

  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695"></script>

<footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    <p class="copyright">
    &copy; Copyright 2022, PyWhy contributors.<br>
</p>
  </div>
  
  <div class="footer-item">
    <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>
  </div>
  
</div>
</footer>
  </body>
</html>