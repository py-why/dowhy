
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B139P18WHM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B139P18WHM');
</script>
    <title>dowhy.gcm.validation &#8212; DoWhy  documentation</title>
<script>
  document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
  document.documentElement.dataset.theme = localStorage.getItem("theme") || "light"
</script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=92025949c220c2e29695" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=92025949c220c2e29695" rel="stylesheet">


  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">
    <div class="bd-header-announcement container-fluid" id="banner">
      

    </div>

    
    <nav class="bd-header navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="bd-header__inner container-xl">

  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    <p class="title logo__title">DoWhy  documentation</p>
  
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="fas fa-bars"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../getting_started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../user_guide/index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../example_notebooks/nb_index.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../dowhy.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../contributing.html">
  Contributing
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../code_repo.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
      <div class="navbar-end-item">
        
<div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        main-branch
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
        <dl>
            <dt>Releases</dt>
            <!-- hard-coding the old versions, as no further old version will be added -->
            <!-- It would be nice if this opened the same page in an older version, but that seems to be overkill
                 right now. Therefore defaulting to the starting page (index). -->
            <dd><a href="/dowhy/v0.8/index.html">v0.8</a></dd>
            <dd><a href="/dowhy/v0.7.1/index.html">v0.7.1</a></dd>
            <dd><a href="/dowhy/v0.7/index.html">v0.7</a></dd>
            <dd><a href="/dowhy/v0.6/index.html">v0.6</a></dd>
            <dd><a href="/dowhy/v0.5.1/index.html">v0.5.1</a></dd>
            <dd><a href="/dowhy/v0.5/index.html">v0.5</a></dd>
            <dd><a href="/dowhy/v0.4/index.html">v0.4</a></dd>
            <dd><a href="/dowhy/v0.2/index.html">v0.2</a></dd>
            <dd><a href="/dowhy/v0.1.1-alpha/index.html">v0.1.1-alpha</a></dd>
            <dd><a href="/dowhy/v0.1-alpha/index.html">v0.1-alpha</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="validation.html">main</a></dd>
        </dl>
    </div>
</div>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="bd-container container-xl">
      <div class="bd-container__inner row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="bd-sidebar-primary col-12 col-md-3 bd-sidebar">
  <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
  </div>
  <div class="sidebar-end-items">
  </div>
</div>


          


<div class="bd-sidebar-secondary d-none d-xl-block col-xl-2 bd-toc">
  
</div>


          
          
          <div class="bd-content col-12 col-md-9 col-xl-7">
              
              <article class="bd-article" role="main">
                
  <h1>Source code for dowhy.gcm.validation</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Contains a method to reject the causal graph and validate causal mechanisms such as post non-linear models.</span>

<span class="sd">Classes and functions in this module should be considered experimental, meaning there might be breaking API changes in</span>
<span class="sd">the future.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">auto</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.multitest</span> <span class="kn">import</span> <span class="n">multipletests</span>

<span class="kn">from</span> <span class="nn">dowhy.gcm.cms</span> <span class="kn">import</span> <span class="n">InvertibleStructuralCausalModel</span>
<span class="kn">from</span> <span class="nn">dowhy.gcm.graph</span> <span class="kn">import</span> <span class="n">DirectedGraph</span><span class="p">,</span> <span class="n">get_ordered_predecessors</span><span class="p">,</span> <span class="n">validate_causal_graph</span><span class="p">,</span> <span class="n">is_root_node</span>
<span class="kn">from</span> <span class="nn">dowhy.gcm.independence_test</span> <span class="kn">import</span> <span class="n">kernel_based</span>


<div class="viewcode-block" id="RejectionResult"><a class="viewcode-back" href="../../../dowhy.gcm.html#dowhy.gcm.validation.RejectionResult">[docs]</a><span class="k">class</span> <span class="nc">RejectionResult</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">REJECTED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">NOT_REJECTED</span> <span class="o">=</span> <span class="n">auto</span><span class="p">(),</span></div>


<div class="viewcode-block" id="refute_causal_structure"><a class="viewcode-back" href="../../../dowhy.gcm.html#dowhy.gcm.validation.refute_causal_structure">[docs]</a><span class="k">def</span> <span class="nf">refute_causal_structure</span><span class="p">(</span><span class="n">causal_graph</span><span class="p">:</span> <span class="n">DirectedGraph</span><span class="p">,</span>
                            <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                            <span class="n">independence_test</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_based</span><span class="p">,</span>
                            <span class="n">conditional_independence_test</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
                                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span>
                            <span class="o">=</span> <span class="n">kernel_based</span><span class="p">,</span>
                            <span class="n">significance_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                            <span class="n">fdr_control_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fdr_bh&#39;</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">RejectionResult</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]]]]]:</span>
    <span class="sd">&quot;&quot;&quot;Validates the assumptions in a causal graph against data. To this end, at each node, we test if the node is dependent on each of its parents, and test the local Markov condition.</span>
<span class="sd">    Note that valid local Markov conditions also imply a valid global Markov condition.</span>

<span class="sd">    :param causal_graph: A directed acyclic graph (DAG).</span>
<span class="sd">    :param data: Observations of variables in the DAG.</span>
<span class="sd">    :param independence_test: Independence test to use for checking edge dependencies.</span>
<span class="sd">    :param conditional_independence_test: Conditional independence test to use for checking local Markov condition.</span>
<span class="sd">    :param significance_level: Significance level for (conditional) independence tests.</span>
<span class="sd">    :param fdr_control_method: Method for false discovery rate (FDR) control. For various options, please refer to `this page &lt;https://www.statsmodels.org/dev/generated/statsmodels.stats.multitest.multipletests.html&gt;`_.</span>
<span class="sd">    :return: Outcome of the validation process. The first element of the tuple indicates whether the graph is valid w.r.t. given data, and the second element gives the summary of tests at each node. An example for X-&gt;Y-&gt;Z:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        [True, {&#39;X&#39;: {&#39;local_markov_test&#39;: {}, &#39;edge_dependence_test&#39;: {}},</span>
<span class="sd">                &#39;Y&#39;: {&#39;local_markov_test&#39;: {}, &#39;edge_dependence_test&#39;: {&#39;X&#39;: {&#39;p_value&#39;: 0.5, &#39;fdr_adjusted_p_value&#39;: 0.5, &#39;success&#39;: True}}},</span>
<span class="sd">                &#39;Z&#39;: {&#39;local_markov_test&#39;: {&#39;p_value&#39;: 0.0, &#39;fdr_adjusted_p_value&#39;: 0.5, &#39;success&#39;: False},</span>
<span class="sd">                      &#39;edge_dependence_test&#39;: {&#39;Y&#39;: {&#39;p_value&#39;: 0.5, &#39;fdr_adjusted_p_value&#39;: 0.5, &#39;success&#39;: True}}}}]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_dag_valid</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">validation_summary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">all_p_values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">causal_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="n">get_ordered_predecessors</span><span class="p">(</span><span class="n">causal_graph</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="n">non_descendants</span> <span class="o">=</span> <span class="n">_get_non_descendants</span><span class="p">(</span><span class="n">causal_graph</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">exclude_parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">lmc_test_result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parents</span> <span class="ow">and</span> <span class="n">non_descendants</span><span class="p">:</span>
            <span class="c1"># test local Markov condition, null hypothesis: conditional independence</span>
            <span class="n">lmc_p_value</span> <span class="o">=</span> <span class="n">conditional_independence_test</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                        <span class="n">data</span><span class="p">[</span><span class="n">non_descendants</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                        <span class="n">data</span><span class="p">[</span><span class="n">parents</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">lmc_test_result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">p_value</span><span class="o">=</span><span class="n">lmc_p_value</span><span class="p">)</span>
            <span class="n">all_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lmc_p_value</span><span class="p">)</span>

        <span class="c1"># test edge dependence, null hypothesis: independence</span>
        <span class="n">edge_dependence_result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="n">edge_p_value</span> <span class="o">=</span> <span class="n">independence_test</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">edge_dependence_result</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">p_value</span><span class="o">=</span><span class="n">edge_p_value</span><span class="p">)</span>
            <span class="n">all_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_p_value</span><span class="p">)</span>

        <span class="n">validation_summary</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">local_markov_test</span><span class="o">=</span><span class="n">lmc_test_result</span><span class="p">,</span>
            <span class="n">edge_dependence_test</span><span class="o">=</span><span class="n">edge_dependence_result</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">fdr_control_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">successes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_p_values</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">significance_level</span>
        <span class="n">adjusted_p_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">successes</span><span class="p">))</span>
        <span class="n">adjusted_p_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">multipletests_result</span> <span class="o">=</span> <span class="n">multipletests</span><span class="p">(</span><span class="n">all_p_values</span><span class="p">,</span> <span class="n">significance_level</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">fdr_control_method</span><span class="p">)</span>
        <span class="n">successes</span> <span class="o">=</span> <span class="n">multipletests_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">adjusted_p_values</span> <span class="o">=</span> <span class="n">multipletests_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># The order of the p-values added to the list is deterministic.</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">causal_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;p_value&#39;</span> <span class="ow">in</span> <span class="n">validation_summary</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;local_markov_test&#39;</span><span class="p">]:</span>
            <span class="n">validation_summary</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;local_markov_test&#39;</span><span class="p">][</span><span class="s1">&#39;fdr_adjusted_p_value&#39;</span><span class="p">]</span> \
                <span class="o">=</span> <span class="n">adjusted_p_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">validation_summary</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;local_markov_test&#39;</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> \
                <span class="o">=</span> <span class="ow">not</span> <span class="n">successes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">is_dag_valid</span> <span class="o">&amp;=</span> <span class="ow">not</span> <span class="n">successes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">get_ordered_predecessors</span><span class="p">(</span><span class="n">causal_graph</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="n">validation_summary</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;edge_dependence_test&#39;</span><span class="p">][</span><span class="n">parent</span><span class="p">][</span><span class="s1">&#39;fdr_adjusted_p_value&#39;</span><span class="p">]</span> \
                <span class="o">=</span> <span class="n">adjusted_p_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">validation_summary</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;edge_dependence_test&#39;</span><span class="p">][</span><span class="n">parent</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> \
                <span class="o">=</span> <span class="n">successes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">is_dag_valid</span> <span class="o">&amp;=</span> <span class="n">successes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">is_dag_valid</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RejectionResult</span><span class="o">.</span><span class="n">NOT_REJECTED</span><span class="p">,</span> <span class="n">validation_summary</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RejectionResult</span><span class="o">.</span><span class="n">REJECTED</span><span class="p">,</span> <span class="n">validation_summary</span></div>


<div class="viewcode-block" id="refute_invertible_model"><a class="viewcode-back" href="../../../dowhy.gcm.html#dowhy.gcm.validation.refute_invertible_model">[docs]</a><span class="k">def</span> <span class="nf">refute_invertible_model</span><span class="p">(</span><span class="n">causal_model</span><span class="p">:</span> <span class="n">InvertibleStructuralCausalModel</span><span class="p">,</span>
                            <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                            <span class="n">independence_test</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_based</span><span class="p">,</span>
                            <span class="n">significance_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                            <span class="n">fdr_control_method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RejectionResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Validate the assumption that the structural causal models can be represented by a</span>
<span class="sd">    :py:class:`InvertibleFunctionalCausalModel &lt;dowhy.gcm.graph.InvertibleFunctionalCausalModel&gt;` (e.g. the causal mechanisms are</span>
<span class="sd">    :py:class:`AdditiveNoiseModels &lt;dowhy.gcm.AdditiveNoiseModel&gt;` and/or :py:class:`PostNonlinearModels &lt;dowhy.gcm.PostNonlinearModel&gt;`).</span>
<span class="sd">    For this, it is checked if the residual of a causal mechanism is independent of the mechanism&#39;s input</span>
<span class="sd">    (i.e. we assume causal sufficiency here). For instance, :py:class:`PostNonlinearModels &lt;dowhy.gcm.PostNonlinearModel&gt;` represent</span>
<span class="sd">        Y = f(g(X) + N),</span>
<span class="sd">    where f is invertible (g does not need to be), X are the parents of Y and N is (assumed to be) independent noise.</span>
<span class="sd">    The latter point is important here. For given data, we can then reconstruct N and perform an independence test between X and N.</span>

<span class="sd">    Note that this method only validates the causal mechanisms and not the graph structure.</span>

<span class="sd">    For the case of post non-linear models, see the following paper for more details:</span>
<span class="sd">        Zhang, K., and A. Hyv√§rinen.</span>
<span class="sd">        On the Identifiability of the Post-Nonlinear Causal Model.</span>
<span class="sd">        25th Conference on Uncertainty in Artificial Intelligence (UAI 2009). AUAI Press, 2009.</span>

<span class="sd">    :param causal_model: A fitted invertible structural causal model.</span>
<span class="sd">    :param data: Observations of variables in the DAG.</span>
<span class="sd">    :param independence_test: Independence test to use for checking if residual and input are dependent.</span>
<span class="sd">    :param significance_level: Significance level for deciding whether input and residual is dependent.</span>
<span class="sd">    :param fdr_control_method: Method for false discovery rate (FDR) control. For various options, please refer to `this page &lt;https://www.statsmodels.org/dev/generated/statsmodels.stats.multitest.multipletests.html&gt;`_.</span>
<span class="sd">    :return: The outcome of the validation. The causal model can not be rejected if all causal mechanisms are consistent with</span>
<span class="sd">             the invertible model assumption.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validate_causal_graph</span><span class="p">(</span><span class="n">causal_model</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>

    <span class="n">all_p_values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">causal_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_root_node</span><span class="p">(</span><span class="n">causal_model</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parents_samples</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">get_ordered_predecessors</span><span class="p">(</span><span class="n">causal_model</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">node</span><span class="p">)]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="n">causal_model</span><span class="o">.</span><span class="n">causal_mechanism</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">estimate_noise</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">parents_samples</span><span class="p">)</span>

            <span class="n">all_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">independence_test</span><span class="p">(</span><span class="n">parents_samples</span><span class="p">,</span> <span class="n">residuals</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">fdr_control_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_p_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RejectionResult</span><span class="o">.</span><span class="n">NOT_REJECTED</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_p_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">significance_level</span><span class="p">)</span> \
            <span class="k">else</span> <span class="n">RejectionResult</span><span class="o">.</span><span class="n">REJECTED</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">RejectionResult</span><span class="o">.</span><span class="n">REJECTED</span> \
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">multipletests</span><span class="p">(</span><span class="n">all_p_values</span><span class="p">,</span> <span class="n">significance_level</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">fdr_control_method</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> \
            <span class="k">else</span> <span class="n">RejectionResult</span><span class="o">.</span><span class="n">NOT_REJECTED</span></div>


<span class="k">def</span> <span class="nf">_get_non_descendants</span><span class="p">(</span><span class="n">causal_graph</span><span class="p">:</span> <span class="n">DirectedGraph</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">exclude_parents</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="n">nodes_to_exclude</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">causal_graph</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">({</span><span class="n">node</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">exclude_parents</span><span class="p">:</span>
        <span class="n">nodes_to_exclude</span> <span class="o">=</span> <span class="n">nodes_to_exclude</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">causal_graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">causal_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">nodes_to_exclude</span><span class="p">)</span>
</pre></div>

              </article>
              

              
              <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              </footer>
              
          </div>
          
      </div>
    </div>

  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695"></script>

<footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    <p class="copyright">
    &copy; Copyright 2022, PyWhy contributors.<br>
</p>
  </div>
  
  <div class="footer-item">
    <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.0.2.<br>
</p>
  </div>
  
</div>
</footer>
  </body>
</html>