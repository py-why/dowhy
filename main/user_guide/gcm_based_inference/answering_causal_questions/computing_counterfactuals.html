
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B139P18WHM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-B139P18WHM');
    </script>
    
    <title>Computing Counterfactuals &#8212; DoWhy  documentation</title>
<script>
  document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
  document.documentElement.dataset.theme = localStorage.getItem("theme") || "light"
</script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=92025949c220c2e29695" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=92025949c220c2e29695" rel="stylesheet">


  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/design-tabs.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Estimating Average Causal Effects" href="average_causal_effect.html" />
    <link rel="prev" title="Simulating the Impact of Interventions" href="simulate_impact_of_interventions.html" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">
    <div class="bd-header-announcement container-fluid" id="banner">
      

    </div>

    
    <nav class="bd-header navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="bd-header__inner container-xl">

  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
    <img src="../../../_static/dowhy-logo-small.png" class="logo__image only-light" alt="Logo image">
    <img src="../../../_static/dowhy-logo-small.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="fas fa-bars"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../getting_started/index.html">
  Getting Started
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../../index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../example_notebooks/nb_index.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../dowhy.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../contributing.html">
  Contributing
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../code_repo.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        main
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
        <dl>
            <dt>Releases</dt>
            <dd><a href="/dowhy/v0.9.1/index.html">v0.9.1</a></dd>
            <dd><a href="/dowhy/v0.9/index.html">v0.9</a></dd>
            <dd><a href="/dowhy/v0.8/index.html">v0.8</a></dd>
            <dd><a href="/dowhy/v0.7.1/index.html">v0.7.1</a></dd>
            <dd><a href="/dowhy/v0.7/index.html">v0.7</a></dd>
            <dd><a href="/dowhy/v0.6/index.html">v0.6</a></dd>
            <dd><a href="/dowhy/v0.5.1/index.html">v0.5.1</a></dd>
            <dd><a href="/dowhy/v0.5/index.html">v0.5</a></dd>
            <dd><a href="/dowhy/v0.4/index.html">v0.4</a></dd>
            <dd><a href="/dowhy/v0.2/index.html">v0.2</a></dd>
            <dd><a href="/dowhy/v0.1.1-alpha/index.html">v0.1.1-alpha</a></dd>
        </dl>        
        <dl>
            <dt>Branches</dt>
            <dd><a href="">main</a></dd>
        </dl>        
    </div>
</div>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="bd-container container-xl">
      <div class="bd-container__inner row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="bd-sidebar-primary col-12 col-md-3 bd-sidebar">
  <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   Introduction to DoWhy
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../effect_inference/index.html">
   Effect inference
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../effect_inference/model.html">
     1. Model a causal problem
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../effect_inference/identify.html">
     2. Identify a target estimand under the model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../effect_inference/estimate.html">
     3. Estimate causal effect based on the identified estimand
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../effect_inference/refute.html">
     4. Refute the obtained estimate
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../effect_inference/comparison.html">
     5. Comparison to other packages
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../index.html">
   GCM-based inference (Experimental)
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../introduction.html">
     Introduction
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="index.html">
     Answering Causal Questions
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="quantify_arrow_strength.html">
       Quantifying Arrow Strength
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="quantify_intrinsic_causal_influence.html">
       Quantifying Intrinsic Causal Influence
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="simulate_impact_of_interventions.html">
       Simulating the Impact of Interventions
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Computing Counterfactuals
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="average_causal_effect.html">
       Estimating Average Causal Effects
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="attribute_distributional_changes.html">
       Attributing Distributional Changes
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../draw_samples.html">
     Generate samples from a GCM
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../customizing_model_assignment.html">
     Customizing Causal Mechanism Assignment
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../estimating_confidence_intervals.html">
     Estimating Confidence Intervals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../independence_tests.html">
     Independence Tests
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../cite.html">
   Citing this package
  </a>
 </li>
</ul>

  </div>
</nav>
  </div>
  <div class="sidebar-end-items">
  </div>
</div>


          


<div class="bd-sidebar-secondary d-none d-xl-block col-xl-2 bd-toc">
  
    
    <div class="toc-item">
      
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-to-use-it">
   How to use it
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#understanding-the-method">
   Understanding the method
  </a>
 </li>
</ul>

</nav>
    </div>
    
    <div class="toc-item">
      
    </div>
    
  
</div>


          
          
          <div class="bd-content col-12 col-md-9 col-xl-7">
              
              <article class="bd-article" role="main">
                
  <section id="computing-counterfactuals">
<h1>Computing Counterfactuals<a class="headerlink" href="#computing-counterfactuals" title="Permalink to this heading"></a></h1>
<p>By computing counterfactuals, we answer the question:</p>
<blockquote>
<div><p>I observed a certain outcome <span class="math notranslate nohighlight">\(z\)</span> for a variable <span class="math notranslate nohighlight">\(Z\)</span> where variable <span class="math notranslate nohighlight">\(X\)</span> was set to a value <span class="math notranslate nohighlight">\(x\)</span>. What
would have happened to the value of <span class="math notranslate nohighlight">\(Z\)</span>, had I intervened on <span class="math notranslate nohighlight">\(X\)</span> to assign it a different value <span class="math notranslate nohighlight">\(x'\)</span>?</p>
</div></blockquote>
<p>As a concrete example, we can imagine the following:</p>
<blockquote>
<div><p>I’m seeing unhealthy high levels of my <a class="reference external" href="https://www.google.com/search?q=cholesterol+ldl">cholesterol LDL</a> (<span class="math notranslate nohighlight">\(Z = 10\)</span>). I didn’t take any medication
against it in recent months (<span class="math notranslate nohighlight">\(x = 0\)</span>). What would have happened to my cholesterol LDL level (<span class="math notranslate nohighlight">\(Z\)</span>),
had I taken a medication dosage of 5g a day (<span class="math notranslate nohighlight">\(X := 5\)</span>)?</p>
</div></blockquote>
<p>Note that the estimation of counterfactuals based on Pearl’s graphical causal model framework requires stronger assumptions than the generation of interventional samples
(see the <a class="reference internal" href="quantify_intrinsic_causal_influence.html#understand-method"><span class="std std-ref">Understanding the method</span></a> section for more details).</p>
<section id="how-to-use-it">
<h2>How to use it<a class="headerlink" href="#how-to-use-it" title="Permalink to this heading"></a></h2>
<p>To see how we can use this method, let’s generate some data:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span><span class="o">,</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dowhy</span> <span class="kn">import</span> <span class="n">gcm</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">X</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Z</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">Y</span> <span class="o">+</span> <span class="mi">80</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">training_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="n">Z</span><span class="p">))</span>
</pre></div>
</div>
<p>If we think of the cholesterol example, one could think of <span class="math notranslate nohighlight">\(Y\)</span> here as some kind of body measurement that affects
the cholesterol LDL level, such as a derivative of the body’s ability to absorb the medication or its metabolism.</p>
<p>Next, we’ll model cause-effect relationships and fit the models to the data. Estimating counterfactuals requires an
invertible SCM that can be represented by additive noise models:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">causal_model</span> <span class="o">=</span> <span class="n">gcm</span><span class="o">.</span><span class="n">InvertibleStructuralCausalModel</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">([(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">)]))</span> <span class="c1"># X -&gt; Y -&gt; Z</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">causal_model</span><span class="o">.</span><span class="n">set_causal_mechanism</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">gcm</span><span class="o">.</span><span class="n">EmpiricalDistribution</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">causal_model</span><span class="o">.</span><span class="n">set_causal_mechanism</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">gcm</span><span class="o">.</span><span class="n">AdditiveNoiseModel</span><span class="p">(</span><span class="n">gcm</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">create_linear_regressor</span><span class="p">()))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">causal_model</span><span class="o">.</span><span class="n">set_causal_mechanism</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="n">gcm</span><span class="o">.</span><span class="n">AdditiveNoiseModel</span><span class="p">(</span><span class="n">gcm</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">create_linear_regressor</span><span class="p">()))</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gcm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">causal_model</span><span class="p">,</span> <span class="n">training_data</span><span class="p">)</span>
</pre></div>
</div>
<p>Suppose we have observed the values <span class="math notranslate nohighlight">\(x=0, y=5, z=110\)</span>. We are interested in knowing if taking medication, e.g.,
setting <span class="math notranslate nohighlight">\(x:=5\)</span>, would have led to a smaller value for <span class="math notranslate nohighlight">\(z\)</span>. The counterfactual value of <span class="math notranslate nohighlight">\(z\)</span> for this
scenario can be estimated in the following way:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gcm</span><span class="o">.</span><span class="n">counterfactual_samples</span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">causal_model</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">observed_data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">Z</span><span class="o">=</span><span class="p">[</span><span class="mi">110</span><span class="p">])))</span>
<span class="go">   X         Y         Z</span>
<span class="go">0  5 -4.82026  80.62051</span>
</pre></div>
</div>
<p>As we can see, <span class="math notranslate nohighlight">\(X\)</span> takes our treatment-/intervention-value of 5, and <span class="math notranslate nohighlight">\(Y\)</span> and <span class="math notranslate nohighlight">\(Z\)</span>
take deterministic values that are <em>based on our trained causal models</em> and the fixed observation. For example, if <span class="math notranslate nohighlight">\(X\)</span> were 0
and <span class="math notranslate nohighlight">\(Y\)</span> were 5, we would expect <span class="math notranslate nohighlight">\(Z\)</span> to be 95 based on the data generation process. However, we observed <span class="math notranslate nohighlight">\(Z\)</span> to be 110,
indicating a noise value of approximately ~15 in this <em>particular</em> sample. With knowledge of this hidden noise factor,
we can estimate the counterfactual value of <span class="math notranslate nohighlight">\(Z\)</span> had we set <span class="math notranslate nohighlight">\(X\)</span> to 5, which is approximately ~80 as shown in the result above.</p>
<p>We can also provide these noise values directly to the function:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gcm</span><span class="o">.</span><span class="n">counterfactual_samples</span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">causal_model</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">noise_data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">Z</span><span class="o">=</span><span class="p">[</span><span class="mi">15</span><span class="p">])))</span>
<span class="go">   X         Y         Z</span>
<span class="go">0  5 -4.845684  80.431559</span>
</pre></div>
</div>
<p>As we see, with <span class="math notranslate nohighlight">\(X\)</span> set to 5 and <span class="math notranslate nohighlight">\(y = -2 \cdot x + 5 = -5\)</span>, <span class="math notranslate nohighlight">\(z\)</span> should be approximately ~65. But
we know the hidden noise for <span class="math notranslate nohighlight">\(Z\)</span> is approximately ~15. So the counterfactual outcome is again
<span class="math notranslate nohighlight">\(z = 3*y + 80 + 15 = 80\)</span>.</p>
<p>It’s important to note that the estimated values we obtained are not exact as we see in the results,
since the model parameters were not learned
perfectly. Specifically, the learned coefficients for <span class="math notranslate nohighlight">\(Y\)</span> and <span class="math notranslate nohighlight">\(Z\)</span> are not precisely -2 and 3, respectively,
as suggested by the data generation process. As usual in machine learning, more data or fine-tuning models can help to
improve accuracy.</p>
</section>
<section id="understanding-the-method">
<span id="understand-method"></span><h2>Understanding the method<a class="headerlink" href="#understanding-the-method" title="Permalink to this heading"></a></h2>
<p>Counterfactuals in graphical causal models are very similar to <a class="reference internal" href="simulate_impact_of_interventions.html"><span class="doc">Simulating the Impact of Interventions</span></a>, with an important
difference: when performing interventions, we look into the future, for counterfactuals we look into
an alternative past. To reflect this in the computation, when performing interventions, we first recreate all noise values
for a specific observation and then estimate the counterfactual outcome. However, this requires stronger modeling
assumptions than generating interventional samples.</p>
<p>Recall that the causal mechanism of a node <span class="math notranslate nohighlight">\(Y\)</span> is represented as <span class="math notranslate nohighlight">\(Y := f(X, N)\)</span>, where <span class="math notranslate nohighlight">\(X\)</span> are the parents of <span class="math notranslate nohighlight">\(Y\)</span> and <span class="math notranslate nohighlight">\(N\)</span> is the noise.
To generate interventional samples for <span class="math notranslate nohighlight">\(Y\)</span>, we can take any random value from <span class="math notranslate nohighlight">\(N\)</span>, but for counterfactuals,
we need to first reconstruct the specific noise value (based on the model) that led to our observation. This requires the
causal mechanism to be invertible with respect to <span class="math notranslate nohighlight">\(N\)</span>, although it does not need to be invertible with respect to <span class="math notranslate nohighlight">\(X\)</span>.
A common modeling assumptions that ensures this are additive noise models of the form
<span class="math notranslate nohighlight">\(Y := f(X) + N\)</span>, where the noise can be reconstructed by <span class="math notranslate nohighlight">\(N = Y - f(X)\)</span>. Note that currently only continuous
data is supported for counterfactual estimation, while there is no restriction on the data type for generating interventional
samples.</p>
<p>To further clarify the role of the noise here, let’s revisit the example in the introduction about high levels of
cholesterol LDL. Seeing that there are many unobserved factors that can impact cholesterol levels, such as exercise and
genetics, the question arises: If I had taken medication, would my LDL levels have been reduced? To answer this, we can use interventions where
we keep the subject specific unobserved factors (i.e., noise) constant and only change the amount of hypothetically taken medicine.
In practice this can be achieved by first reconstructing the noise and then use that specific value
to estimate the LDL levels after intervening on the amount of medicine. Here it is crucial to use the reconstructed noise value rather
than randomly sampling it from the noise distribution. Otherwise, one may see a reduction in LDL levels, not because of
the medication itself, but because of the generated noise value that coincidentally causes low levels. Assuming the modeling
assumptions are approximately correct, we can then analyze whether the medication would have helped in the counterfactual scenario.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Remark on invertible mechanisms</strong>: Generally, mechanisms that are invertible with respect to <span class="math notranslate nohighlight">\(N\)</span> allow us to estimate point
counterfactuals. However, it is also possible to allow some mechanisms to be non-invertible. In this case, however, we would
obtain a counterfactual <em>distribution</em> based on the observational evidence, which may not necessarily be point-wise.</p>
</div>
</section>
</section>


              </article>
              

              
              <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="simulate_impact_of_interventions.html" title="previous page">
      <i class="fas fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Simulating the Impact of Interventions</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="average_causal_effect.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">Estimating Average Causal Effects</p>
  </div>
  <i class="fas fa-angle-right"></i>
  </a>
</div>
              </footer>
              
          </div>
          
      </div>
    </div>

  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695"></script>

<footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    <p class="copyright">
    &copy; Copyright 2022, PyWhy contributors.<br>
</p>
  </div>
  
  <div class="footer-item">
    <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>
  </div>
  
</div>
</footer>
  </body>
</html>