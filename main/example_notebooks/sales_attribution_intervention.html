
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B139P18WHM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-B139P18WHM');
    </script>
    
    <title>Causal attribution to sales growth and spend intervention &#8212; DoWhy  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=949a1ff5" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=0c6e27e1"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'example_notebooks/sales_attribution_intervention';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="DoWhy example on ihdp (Infant Health and Development Program) dataset" href="dowhy_ihdp_data_example.html" />
    <link rel="prev" title="Counterfactual Fairness" href="counterfactual_fairness_dowhy.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="main" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/dowhy-logo-small.png" class="logo__image only-light" alt="DoWhy  documentation - Home"/>
    <img src="../_static/dowhy-logo-small.png" class="logo__image only-dark pst-js-only" alt="DoWhy  documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../getting_started/index.html">
    Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="nb_index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../cite.html">
    Citing this package
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../contributing.html">
    Contributing
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../dowhy.html">
    dowhy package
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../code_repo.html">
    Release notes
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item"><div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        main
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
        <dl>
            <dt>Releases</dt>
            <dd><a href="/dowhy/v0.9.1/index.html">v0.9.1</a></dd>
            <dd><a href="/dowhy/v0.9/index.html">v0.9</a></dd>
            <dd><a href="/dowhy/v0.8/index.html">v0.8</a></dd>
            <dd><a href="/dowhy/v0.7.1/index.html">v0.7.1</a></dd>
            <dd><a href="/dowhy/v0.7/index.html">v0.7</a></dd>
            <dd><a href="/dowhy/v0.6/index.html">v0.6</a></dd>
            <dd><a href="/dowhy/v0.5.1/index.html">v0.5.1</a></dd>
            <dd><a href="/dowhy/v0.5/index.html">v0.5</a></dd>
            <dd><a href="/dowhy/v0.4/index.html">v0.4</a></dd>
            <dd><a href="/dowhy/v0.2/index.html">v0.2</a></dd>
            <dd><a href="/dowhy/v0.12/index.html">v0.12</a></dd>
            <dd><a href="/dowhy/v0.11.1/index.html">v0.11.1</a></dd>
            <dd><a href="/dowhy/v0.11/index.html">v0.11</a></dd>
            <dd><a href="/dowhy/v0.10.1/index.html">v0.10.1</a></dd>
            <dd><a href="/dowhy/v0.10/index.html">v0.10</a></dd>
            <dd><a href="/dowhy/v0.1.1-alpha/index.html">v0.1.1-alpha</a></dd>
        </dl>        
        <dl>
            <dt>Branches</dt>
            <dd><a href="">main</a></dd>
        </dl>        
    </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../getting_started/index.html">
    Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="nb_index.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../cite.html">
    Citing this package
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../contributing.html">
    Contributing
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../dowhy.html">
    dowhy package
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../code_repo.html">
    Release notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        main
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
        <dl>
            <dt>Releases</dt>
            <dd><a href="/dowhy/v0.9.1/index.html">v0.9.1</a></dd>
            <dd><a href="/dowhy/v0.9/index.html">v0.9</a></dd>
            <dd><a href="/dowhy/v0.8/index.html">v0.8</a></dd>
            <dd><a href="/dowhy/v0.7.1/index.html">v0.7.1</a></dd>
            <dd><a href="/dowhy/v0.7/index.html">v0.7</a></dd>
            <dd><a href="/dowhy/v0.6/index.html">v0.6</a></dd>
            <dd><a href="/dowhy/v0.5.1/index.html">v0.5.1</a></dd>
            <dd><a href="/dowhy/v0.5/index.html">v0.5</a></dd>
            <dd><a href="/dowhy/v0.4/index.html">v0.4</a></dd>
            <dd><a href="/dowhy/v0.2/index.html">v0.2</a></dd>
            <dd><a href="/dowhy/v0.12/index.html">v0.12</a></dd>
            <dd><a href="/dowhy/v0.11.1/index.html">v0.11.1</a></dd>
            <dd><a href="/dowhy/v0.11/index.html">v0.11</a></dd>
            <dd><a href="/dowhy/v0.10.1/index.html">v0.10.1</a></dd>
            <dd><a href="/dowhy/v0.10/index.html">v0.10</a></dd>
            <dd><a href="/dowhy/v0.1.1-alpha/index.html">v0.1.1-alpha</a></dd>
        </dl>        
        <dl>
            <dt>Branches</dt>
            <dd><a href="">main</a></dd>
        </dl>        
    </div>
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Introductory examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="dowhy_simple_example.html">Basic Example for Calculating the Causal Effect</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcm_basic_example.html">Basic Example for Graphical Causal Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcm_draw_samples.html">Basic Example for generating samples from a GCM</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_confounder_example.html">Confounding Example: Finding causal effects from observed data</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy-conditional-treatment-effects.html">Conditional Average Treatment Effects (CATE) with DoWhy and EconML</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial-causalinference-machinelearning-using-dowhy-econml.html">Tutorial on Causal Inference and its Connections to Machine Learning (Using DoWhy+EconML)</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_mediation_analysis.html">Mediation analysis with DoWhy: Direct and Indirect Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_refuter_notebook.html">Iterating over multiple refutation tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="do_sampler_demo.html">Do-sampler Introduction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Real world-inspired examples</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="DoWhy-The%20Causal%20Story%20Behind%20Hotel%20Booking%20Cancellations.html">Exploring Causes of Hotel Booking Cancellations</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_example_effect_of_memberrewards_program.html">Estimating the Effect of a Member Rewards Program</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcm_online_shop.html">Causal Attributions and Root-Cause Analysis in an Online Shop</a></li>

<li class="toctree-l1"><a class="reference internal" href="gcm_rca_microservice_architecture.html">Finding the Root Cause of Elevated Latencies in a Microservice Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcm_401k_analysis.html">Impact of 401(k) eligibility on net financial assets</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcm_supply_chain_dist_change.html">Finding Root Causes of Changes in a Supply Chain</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcm_icc.html">Estimating intrinsic causal influences in real-world examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcm_counterfactual_medical_dry_eyes.html">Counterfactual Analysis in a Medical Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcm_falsify_dag.html">Falsification of User-Given Directed Acyclic Graphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="counterfactual_fairness_dowhy.html">Counterfactual Fairness</a></li>






<li class="toctree-l1 current active"><a class="current reference internal" href="#">Causal attribution to sales growth and spend intervention</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples on benchmarks datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="dowhy_ihdp_data_example.html">DoWhy example on ihdp (Infant Health and Development Program) dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_lalonde_example.html">DoWhy example on the Lalonde dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_refutation_testing.html">Applying refutation tests to the Lalonde and IHDP datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="gcm_401k_analysis.html">Impact of 401(k) eligibility on net financial assets</a></li>
<li class="toctree-l1"><a class="reference internal" href="prediction/dowhy_causal_prediction_demo.html">Demo for DoWhy Causal Prediction on MNIST</a></li>
<li class="toctree-l1"><a class="reference internal" href="lalonde_pandas_api.html">Lalonde Pandas API Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="counterfactual_fairness_dowhy.html">Counterfactual Fairness</a></li>






<li class="toctree-l1"><a class="reference internal" href="dowhy_twins_example.html">DoWhy example on Twins dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Modeling and refuting causal assumptions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="load_graph_example.html">Different ways to load an input graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_causal_discovery_example.html">Causal Discovery example</a></li>




<li class="toctree-l1"><a class="reference internal" href="gcm_falsify_dag.html">Falsification of User-Given Directed Acyclic Graphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="sensitivity_analysis_testing.html">Sensitivity Analysis for Regression Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="sensitivity_analysis_nonparametric_estimators.html">Sensitivity analysis for non-parametric causal estimators</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_refuter_notebook.html">Iterating over multiple refutation tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_refuter_assess_overlap.html">Assessing Support and Overlap with OverRule</a></li>



<li class="toctree-l1"><a class="reference internal" href="dowhy_ranking_methods.html">Ranking of estimation methods for a given dataset</a></li>


<li class="toctree-l1"><a class="reference internal" href="dowhy_demo_dummy_outcome_refuter.html">A Simple Example on Creating a Custom Refutation Using User-Defined Outcome Functions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="dowhy_estimation_methods.html">DoWhy: Different estimation methods for causal inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy-simple-iv-example.html">Simple example on using Instrumental Variables method for estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_interpreter.html">DoWhy: Interpreters for Causal Estimators</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_mediation_analysis.html">Mediation analysis with DoWhy: Direct and Indirect Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_multiple_treatments.html">Estimating effect of multiple treatments</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_efficient_backdoor_example.html">Finding optimal adjustment sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="identifying_effects_using_id_algorithm.html">Identifying Effect using ID Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_optimize_backdoor_example.html">Example to demonstrate optimized backdoor variable search for Causal Identification</a></li>
<li class="toctree-l1"><a class="reference internal" href="dowhy_functional_api.html">Functional API Preview</a></li>

<li class="toctree-l1"><a class="reference internal" href="dowhy_causal_api.html">Demo for the DoWhy causal API</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="nb_index.html" class="nav-link">Example notebooks</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Causal attribution to sales growth and spend intervention</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="Causal-attribution-to-sales-growth-and-spend-intervention">
<h1>Causal attribution to sales growth and spend intervention<a class="headerlink" href="#Causal-attribution-to-sales-growth-and-spend-intervention" title="Link to this heading">#</a></h1>
<section id="The-Scenario">
<h2>The Scenario<a class="headerlink" href="#The-Scenario" title="Link to this heading">#</a></h2>
<p>Suppose we have an advertiser selling products online. To promote sales, they give out discounts through price promotions, and advertise online through both display ads and sponsored ads in search results pages. To prepare for an upcoming business review, the advertiser compares 2024 and 2023 data and observes steady KPI growth such as sales, and product page views. However, the analytics team wonders what factors drive that growth, is it advertising, price promotion, or simply organic growth
due to shopper trends? Answers to this question are key to understanding past growth. Furthermore, this advertiser wants actionable suggestions for business planning, such as spending on areas with higher returns on investment to double down next. In the following scenario, we will use DoWhy two-fold: first to causally attribute KPI growth drivers properly, so the analytics team understands what fueled past growth in a data-driven way. Second, we conduct interventions based on causal impact
estimates to derive incremental return on investment (iROI), so the advertiser can forecast future KPI growth with additional investment. These factors and KPIs are:</p>
<ul class="simple">
<li><p><strong>dsp_spend</strong>: Ad spend on Demand Side Platform (DSP) through display ads</p></li>
<li><p><strong>sp_spend</strong>: Ad spend on search results pages to bump up product rankings for easy discovery</p></li>
<li><p><strong>discount</strong>: Discounts given through price reductions</p></li>
<li><p><strong>special_shopping_event</strong>: A binary variable indicating whether a shopping event hosted by the ecommerce platform took place, such as Black Friday or Cyber Monday</p></li>
<li><p><strong>other_shopping_event</strong>: A binary variable indicating other shopping events off the ecommerce platform. It can be from the advertiser itself, or its advertising with other platforms.</p></li>
<li><p><strong>dpv</strong>: Number of product detail page views</p></li>
<li><p><strong>sale</strong>: Daily revenue on the focal ecommerce platform</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dowhy</span><span class="w"> </span><span class="kn">import</span> <span class="n">gcm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dowhy.utils.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.stats.multitest</span><span class="w"> </span><span class="kn">import</span> <span class="n">multipletests</span>

<span class="n">gcm</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">general</span><span class="o">.</span><span class="n">set_random_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</section>
<section id="1.-Explore-the-data">
<h2>1. Explore the data<a class="headerlink" href="#1.-Explore-the-data" title="Link to this heading">#</a></h2>
<p>First, let’s load our data representing the spending, discounts, sale and other information for 2023 and 2024. Note that for this simulated data, we didn’t change the distribution of price discounts over periods of comparison and shouldn’t detect as such in the later attribution model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;datasets/sales_attribution.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dsp_spend</th>
      <th>sp_spend</th>
      <th>dpv</th>
      <th>discount</th>
      <th>sale</th>
      <th>activity_date</th>
      <th>year</th>
      <th>quarter</th>
      <th>month</th>
      <th>special_shopping_event</th>
      <th>other_shopping_event</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>11864.799390</td>
      <td>2609.702789</td>
      <td>54954.823150</td>
      <td>26167.824599</td>
      <td>76740.886670</td>
      <td>2023-01-01</td>
      <td>2023</td>
      <td>1</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11084.057110</td>
      <td>2568.540570</td>
      <td>44907.063324</td>
      <td>22340.009780</td>
      <td>52480.718941</td>
      <td>2023-01-02</td>
      <td>2023</td>
      <td>1</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>16680.850945</td>
      <td>2847.576700</td>
      <td>151643.912564</td>
      <td>68301.747813</td>
      <td>628062.966309</td>
      <td>2023-01-03</td>
      <td>2023</td>
      <td>1</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3</th>
      <td>15473.576264</td>
      <td>2788.515831</td>
      <td>121173.343955</td>
      <td>18906.050402</td>
      <td>307547.583964</td>
      <td>2023-01-04</td>
      <td>2023</td>
      <td>1</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10308.414302</td>
      <td>2523.591011</td>
      <td>36234.267337</td>
      <td>18198.689563</td>
      <td>35602.101926</td>
      <td>2023-01-05</td>
      <td>2023</td>
      <td>1</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>To causally attribute factors of interests to changes, we first need to define time periods for comparisons.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">generate_new_old_dataframes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">new_year</span><span class="p">,</span> <span class="n">new_quarters</span><span class="p">,</span> <span class="n">new_months</span><span class="p">,</span> <span class="n">old_year</span><span class="p">,</span> <span class="n">old_quarters</span><span class="p">,</span> <span class="n">old_months</span><span class="p">):</span>
    <span class="c1"># Filter new data based on year, quarters, and months</span>
    <span class="n">new_conditions</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_year</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;quarter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">new_quarters</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">new_months</span><span class="p">))</span>
    <span class="n">df_new</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">new_conditions</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Filter old data based on year, quarters, and months</span>
    <span class="n">old_conditions</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">old_year</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;quarter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">old_quarters</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">old_months</span><span class="p">))</span>
    <span class="n">df_old</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">old_conditions</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df_new</span><span class="p">,</span> <span class="n">df_old</span>

<span class="n">df_new</span><span class="p">,</span> <span class="n">df_old</span> <span class="o">=</span> <span class="n">generate_new_old_dataframes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">new_year</span><span class="o">=</span><span class="mi">2024</span><span class="p">,</span> <span class="n">new_quarters</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">new_months</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="n">old_year</span><span class="o">=</span><span class="mi">2023</span><span class="p">,</span> <span class="n">old_quarters</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">old_months</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Then we define cumulative distribution functions to eyeball changes in metrics across two periods. Let’s plot them:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_metric_distributions</span><span class="p">(</span><span class="n">df_new</span><span class="p">,</span> <span class="n">df_old</span><span class="p">,</span> <span class="n">metric_columns</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">metric_column</span> <span class="ow">in</span> <span class="n">metric_columns</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">kde_new</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">df_new</span><span class="p">[</span><span class="n">metric_column</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        <span class="n">kde_old</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">df_old</span><span class="p">[</span><span class="n">metric_column</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>

        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">df_new</span><span class="p">[</span><span class="n">metric_column</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df_old</span><span class="p">[</span><span class="n">metric_column</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
            <span class="nb">max</span><span class="p">(</span><span class="n">df_new</span><span class="p">[</span><span class="n">metric_column</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">df_old</span><span class="p">[</span><span class="n">metric_column</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
            <span class="mi">1000</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">kde_new</span><span class="p">(</span><span class="n">x_range</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#FF6B6B&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;After&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">kde_old</span><span class="p">(</span><span class="n">x_range</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#4ECDC4&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Before&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">kde_new</span><span class="p">(</span><span class="n">x_range</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#FF6B6B&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">kde_old</span><span class="p">(</span><span class="n">x_range</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#4ECDC4&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">metric_column</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Comparison of </span><span class="si">{</span><span class="n">metric_column</span><span class="si">}</span><span class="s1"> distribution&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Here, we are interested in the ‘dpv’ and ‘sale’ variables.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define KPI</span>
<span class="n">metric_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dpv&#39;</span><span class="p">,</span> <span class="s1">&#39;sale&#39;</span><span class="p">]</span>
<span class="n">plot_metric_distributions</span><span class="p">(</span><span class="n">df_new</span><span class="p">,</span> <span class="n">df_old</span><span class="p">,</span> <span class="n">metric_columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/example_notebooks_sales_attribution_intervention_11_0.png" src="../_images/example_notebooks_sales_attribution_intervention_11_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/example_notebooks_sales_attribution_intervention_11_1.png" src="../_images/example_notebooks_sales_attribution_intervention_11_1.png" />
</div>
</div>
<p>We can further quantify the magnitude of changes by comparing mean, median and variance of both KPIs and potential drivers.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">compare_metrics</span><span class="p">(</span><span class="n">df_new</span><span class="p">,</span> <span class="n">df_old</span><span class="p">,</span> <span class="n">metrics</span><span class="p">):</span>
    <span class="n">comparison_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mean_old</span> <span class="o">=</span> <span class="n">df_old</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">median_old</span> <span class="o">=</span> <span class="n">df_old</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
            <span class="n">variance_old</span> <span class="o">=</span> <span class="n">df_old</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>

            <span class="n">mean_new</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">median_new</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
            <span class="n">variance_new</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">mean_old</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean for </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> in the old data is zero. Skipping mean change calculation.&quot;</span><span class="p">)</span>
                <span class="n">mean_change</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mean_change</span> <span class="o">=</span> <span class="p">((</span><span class="n">mean_new</span> <span class="o">-</span> <span class="n">mean_old</span><span class="p">)</span> <span class="o">/</span> <span class="n">mean_old</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

            <span class="k">if</span> <span class="n">median_old</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Median for </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> in the old data is zero. Skipping median change calculation.&quot;</span><span class="p">)</span>
                <span class="n">median_change</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">median_change</span> <span class="o">=</span> <span class="p">((</span><span class="n">median_new</span> <span class="o">-</span> <span class="n">median_old</span><span class="p">)</span> <span class="o">/</span> <span class="n">median_old</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

            <span class="k">if</span> <span class="n">variance_old</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variance for </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> in the old data is zero. Skipping variance change calculation.&quot;</span><span class="p">)</span>
                <span class="n">variance_change</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">variance_change</span> <span class="o">=</span> <span class="p">((</span><span class="n">variance_new</span> <span class="o">-</span> <span class="n">variance_old</span><span class="p">)</span> <span class="o">/</span> <span class="n">variance_old</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

            <span class="n">comparison_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;Metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                <span class="s1">&#39;Δ mean&#39;</span><span class="p">:</span> <span class="n">mean_change</span><span class="p">,</span>
                <span class="s1">&#39;Δ median&#39;</span><span class="p">:</span> <span class="n">median_change</span><span class="p">,</span>
                <span class="s1">&#39;Δ variance&#39;</span><span class="p">:</span> <span class="n">variance_change</span>
            <span class="p">})</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metric </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> not found in one of the DataFrames: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">pass</span>

    <span class="n">comparison_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comparison_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">comparison_df</span>
</pre></div>
</div>
</div>
<p>For simplicity, below we assume KPIs are revenue (sale), and product views (DPV), with potential drivers including ad spend on demand side platform (dsp_spend) and search results (sp_spend), and price promotion (discount).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">comparison_df</span> <span class="o">=</span> <span class="n">compare_metrics</span><span class="p">(</span><span class="n">df_new</span><span class="p">,</span> <span class="n">df_old</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;sale&#39;</span><span class="p">,</span> <span class="s1">&#39;dpv&#39;</span><span class="p">,</span> <span class="s1">&#39;dsp_spend&#39;</span><span class="p">,</span>  <span class="s1">&#39;sp_spend&#39;</span><span class="p">,</span> <span class="s1">&#39;discount&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">comparison_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
      Metric     Δ mean   Δ median  Δ variance
0       sale  11.274001  84.089817  -95.972002
1        dpv   8.843596  12.453083  -95.913214
2  dsp_spend   6.387894   3.718354  -66.203836
3   sp_spend  10.335289  10.013358  312.605493
4   discount  -1.837933  32.438169  -99.570962
</pre></div></div>
</div>
</section>
<section id="2.-Draw-causal-graph">
<h2>2. Draw causal graph<a class="headerlink" href="#2.-Draw-causal-graph" title="Link to this heading">#</a></h2>
<section id="2.1.Set-up-basic-causal-graphs">
<h3>2.1.Set up basic causal graphs<a class="headerlink" href="#2.1.Set-up-basic-causal-graphs" title="Link to this heading">#</a></h3>
<p>In the first step, we make use of our domain knowledge that all the ad investment and the shopping events can be potential causes of product page views and sale, but not vice versa. Further, detail page views can also lead to sales, regardless of ad investment.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;spend&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
        <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;dpv&#39;</span><span class="p">))</span>
        <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;sale&#39;</span><span class="p">))</span>
<span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;special_shopping_event&#39;</span><span class="p">,</span> <span class="s1">&#39;dpv&#39;</span><span class="p">))</span>
<span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;other_shopping_event&#39;</span><span class="p">,</span> <span class="s1">&#39;dpv&#39;</span><span class="p">))</span>
<span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;special_shopping_event&#39;</span><span class="p">,</span> <span class="s1">&#39;sale&#39;</span><span class="p">))</span>
<span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;other_shopping_event&#39;</span><span class="p">,</span> <span class="s1">&#39;sale&#39;</span><span class="p">))</span>
<span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;discount&#39;</span><span class="p">,</span> <span class="s1">&#39;sale&#39;</span><span class="p">))</span>
<span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;dpv&#39;</span><span class="p">,</span> <span class="s1">&#39;sale&#39;</span><span class="p">))</span>

<span class="n">causal_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span><span class="p">(</span><span class="n">causal_graph</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/example_notebooks_sales_attribution_intervention_19_0.png" src="../_images/example_notebooks_sales_attribution_intervention_19_0.png" />
</div>
</div>
<p>It is unlikely that all these edges are significant. Let’s prune some potential causes in the next step. This is to have a more refined causal graph. i.e, closer to the truth.</p>
</section>
<section id="2.2.-Prune-nodes-and-edges">
<h3>2.2. Prune nodes and edges<a class="headerlink" href="#2.2.-Prune-nodes-and-edges" title="Link to this heading">#</a></h3>
<p>One way to prune insignificant causal connections is conducting causal minimality tests through statistical dependence tests. The causality minimality test rules out any parent-child edge (<span class="math notranslate nohighlight">\(X\to Y\)</span>) for a node <span class="math notranslate nohighlight">\(Y\)</span> if <span class="math notranslate nohighlight">\(Y\)</span> is conditionally independent of <span class="math notranslate nohighlight">\(X\)</span> given other parents of <span class="math notranslate nohighlight">\(Y\)</span>. If that is the case, node <span class="math notranslate nohighlight">\(X\)</span> does not provide additional information on top of the other parents of <span class="math notranslate nohighlight">\(Y\)</span>. In layman’s language, some ads may not provide incremental
information in the presence of others. Thus, we can remove those edges of <span class="math notranslate nohighlight">\(X \to Y\)</span>. Note that the test is adjusted for multihypothesis testing to guarantee a consistent false discovery rate.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">test_causal_minimality</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;kernel&#39;</span><span class="p">,</span> <span class="n">significance_level</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">fdr_control_method</span><span class="o">=</span><span class="s1">&#39;fdr_bh&#39;</span><span class="p">):</span>
    <span class="n">p_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_parents</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">all_parents</span><span class="p">:</span>
        <span class="n">tmp_conditioning_set</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_parents</span><span class="p">)</span>
        <span class="n">tmp_conditioning_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">p_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gcm</span><span class="o">.</span><span class="n">independence_test</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="n">tmp_conditioning_set</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">fdr_control_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p_vals</span> <span class="o">=</span> <span class="n">multipletests</span><span class="p">(</span><span class="n">p_vals</span><span class="p">,</span> <span class="n">significance_level</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">fdr_control_method</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">nodes_above_threshold</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nodes_below_threshold</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_parents</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">p_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">significance_level</span><span class="p">:</span>
            <span class="n">nodes_above_threshold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nodes_below_threshold</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Significant connection:&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nodes_above_threshold</span><span class="p">)])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Insignificant connection:&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nodes_below_threshold</span><span class="p">)])</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nodes_below_threshold</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then we remove insignificant edges and their associated nodes, resulting a refined causal graph.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">insignificant_parent</span> <span class="ow">in</span> <span class="n">test_causal_minimality</span><span class="p">(</span><span class="n">causal_graph</span><span class="p">,</span> <span class="s1">&#39;sale&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="n">causal_graph</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">insignificant_parent</span><span class="p">,</span> <span class="s1">&#39;sale&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">insignificant_parent</span> <span class="ow">in</span> <span class="n">test_causal_minimality</span><span class="p">(</span><span class="n">causal_graph</span><span class="p">,</span> <span class="s1">&#39;dpv&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="n">causal_graph</span><span class="o">.</span><span class="n">remove_edge</span><span class="p">(</span><span class="n">insignificant_parent</span><span class="p">,</span> <span class="s1">&#39;dpv&#39;</span><span class="p">)</span>

<span class="n">cols_to_remove</span><span class="o">=</span><span class="p">[]</span>
<span class="n">cols_to_remove</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">node</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">causal_graph</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">causal_graph</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">+</span> <span class="n">causal_graph</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Significant connection: [(&#39;discount&#39;, &#39;sale&#39;), (&#39;dpv&#39;, &#39;sale&#39;), (&#39;dsp_spend&#39;, &#39;sale&#39;), (&#39;sp_spend&#39;, &#39;sale&#39;), (&#39;special_shopping_event&#39;, &#39;sale&#39;)]
Insignificant connection: [(&#39;other_shopping_event&#39;, &#39;sale&#39;)]
Significant connection: [(&#39;dsp_spend&#39;, &#39;dpv&#39;), (&#39;sp_spend&#39;, &#39;dpv&#39;)]
Insignificant connection: [(&#39;other_shopping_event&#39;, &#39;dpv&#39;), (&#39;special_shopping_event&#39;, &#39;dpv&#39;)]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">causal_graph</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols_to_remove</span><span class="p">))</span>
<span class="n">plot</span><span class="p">(</span><span class="n">causal_graph</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/example_notebooks_sales_attribution_intervention_26_0.png" src="../_images/example_notebooks_sales_attribution_intervention_26_0.png" />
</div>
</div>
<p>Interestingly, the ‘other_shopping_event’ variable has no significant impact on either ‘dpv’ or ‘sale’.</p>
</section>
</section>
<section id="3.-Fit-causal-graph">
<h2>3. Fit causal graph<a class="headerlink" href="#3.-Fit-causal-graph" title="Link to this heading">#</a></h2>
<p>Next, we need to assign functional causal models (FCMs) to each node, which describe the data generation process from x to y with an error term. The auto assignment method compares different prediction models for each node and takes the one with the smallest error. The <code class="docutils literal notranslate"><span class="pre">quality</span></code> parameter controls the set of model types that are tested, where <code class="docutils literal notranslate"><span class="pre">BETTER</span></code> indicates some of the most common regression and classification models, such as trees, support vector regression etc. You can also use
<code class="docutils literal notranslate"><span class="pre">GOOD</span></code> which fits fewer models to speed up, or <code class="docutils literal notranslate"><span class="pre">BEST</span></code> that is computationally heavy (and requres AutoGluon to be installed). After assigning the models, we can fit them to the data:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">causal_model</span> <span class="o">=</span> <span class="n">gcm</span><span class="o">.</span><span class="n">StructuralCausalModel</span><span class="p">(</span><span class="n">causal_graph</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">gcm</span><span class="o">.</span><span class="n">auto</span><span class="o">.</span><span class="n">assign_causal_mechanisms</span><span class="p">(</span><span class="n">causal_model</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="n">gcm</span><span class="o">.</span><span class="n">auto</span><span class="o">.</span><span class="n">AssignmentQuality</span><span class="o">.</span><span class="n">BETTER</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
When using this auto assignment function, the given data is used to automatically assign a causal mechanism to each node. Note that causal mechanisms can also be customized and assigned manually.
The following types of causal mechanisms are considered for the automatic selection:

If root node:
An empirical distribution, i.e., the distribution is represented by randomly sampling from the provided data. This provides a flexible and non-parametric way to model the marginal distribution and is valid for all types of data modalities.

If non-root node and the data is continuous:
Additive Noise Models (ANM) of the form X_i = f(PA_i) + N_i, where PA_i are the parents of X_i and the unobserved noise N_i is assumed to be independent of PA_i.To select the best model for f, different regression models are evaluated and the model with the smallest mean squared error is selected.Note that minimizing the mean squared error here is equivalent to selecting the best choice of an ANM.

If non-root node and the data is discrete:
Discrete Additive Noise Models have almost the same definition as non-discrete ANMs, but come with an additional constraint for f to only return discrete values.
Note that &#39;discrete&#39; here refers to numerical values with an order. If the data is categorical, consider representing them as strings to ensure proper model selection.

If non-root node and the data is categorical:
A functional causal model based on a classifier, i.e., X_i = f(PA_i, N_i).
Here, N_i follows a uniform distribution on [0, 1] and is used to randomly sample a class (category) using the conditional probability distribution produced by a classification model.Here, different model classes are evaluated using the (negative) F1 score and the best performing model class is selected.

In total, 6 nodes were analyzed:

--- Node: dsp_spend
Node dsp_spend is a root node. Therefore, assigning &#39;Empirical Distribution&#39; to the node representing the marginal distribution.

--- Node: sp_spend
Node sp_spend is a root node. Therefore, assigning &#39;Empirical Distribution&#39; to the node representing the marginal distribution.

--- Node: special_shopping_event
Node special_shopping_event is a root node. Therefore, assigning &#39;Empirical Distribution&#39; to the node representing the marginal distribution.

--- Node: discount
Node discount is a root node. Therefore, assigning &#39;Empirical Distribution&#39; to the node representing the marginal distribution.

--- Node: dpv
Node dpv is a non-root node with continuous data. Assigning &#39;AdditiveNoiseModel using ExtraTreesRegressor&#39; to the node.
This represents the causal relationship as dpv := f(dsp_spend,sp_spend) + N.
For the model selection, the following models were evaluated on the mean squared error (MSE) metric:
ExtraTreesRegressor: 166470642.14064425
RandomForestRegressor: 202413093.75654438
HistGradientBoostingRegressor: 210199781.95027882
AdaBoostRegressor: 277405500.13712883
KNeighborsRegressor: 367859348.3758382
Pipeline(steps=[(&#39;polynomialfeatures&#39;, PolynomialFeatures(include_bias=False)),
                (&#39;linearregression&#39;, LinearRegression)]): 428084148.87153566
LinearRegression: 548678262.1828389
RidgeCV: 548678284.3329667
LassoCV(max_iter=10000): 557118490.7847294
SVR: 2900199761.6189833

--- Node: sale
Node sale is a non-root node with continuous data. Assigning &#39;AdditiveNoiseModel using ExtraTreesRegressor&#39; to the node.
This represents the causal relationship as sale := f(discount,dpv,dsp_spend,sp_spend,special_shopping_event) + N.
For the model selection, the following models were evaluated on the mean squared error (MSE) metric:
ExtraTreesRegressor: 2332009300.2678514
RandomForestRegressor: 5154831913.930094
AdaBoostRegressor: 7802031657.73537
LinearRegression: 20252807738.720932
RidgeCV: 20398999697.143623
KNeighborsRegressor: 25224016431.708626
HistGradientBoostingRegressor: 29079555677.630787
LassoCV(max_iter=10000): 32196615412.165276
SVR: 134229564521.51865

===Note===
Note, based on the selected auto assignment quality, the set of evaluated models changes.
For more insights toward the quality of the fitted graphical causal model, consider using the evaluate_causal_model function after fitting the causal mechanisms.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gcm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">causal_model</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Fitting causal mechanism of node discount: 100%|██████████| 6/6 [00:00&lt;00:00, 27.64it/s]
</pre></div></div>
</div>
</section>
<section id="4.-Identify-causal-drivers-for-KPI-changes">
<h2>4. Identify causal drivers for KPI changes<a class="headerlink" href="#4.-Identify-causal-drivers-for-KPI-changes" title="Link to this heading">#</a></h2>
<p>To answer the question on drivers for past growth, we test if any of the potential drivers lead to KPI changes by comparing the data from 2023 and 2024. Below we quantify the contribution to changes in the mean of our KPI, but one can similarly estimate the contributions with respect to the median or variance etc.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">calculate_difference_estimation</span><span class="p">(</span><span class="n">causal_model</span><span class="p">,</span> <span class="n">df_old</span><span class="p">,</span> <span class="n">df_new</span><span class="p">,</span> <span class="n">target_column</span><span class="p">,</span> <span class="n">difference_estimation_func</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">confidence_level</span><span class="o">=</span><span class="mf">0.90</span><span class="p">,</span> <span class="n">num_bootstrap_resamples</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>

    <span class="n">difference_contribs</span><span class="p">,</span> <span class="n">uncertainty_contribs</span> <span class="o">=</span> <span class="n">gcm</span><span class="o">.</span><span class="n">confidence_intervals</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="p">:</span> <span class="n">gcm</span><span class="o">.</span><span class="n">distribution_change</span><span class="p">(</span><span class="n">causal_model</span><span class="p">,</span>
                                          <span class="n">df_old</span><span class="p">,</span>
                                          <span class="n">df_new</span><span class="p">,</span>
                                          <span class="n">target_column</span><span class="p">,</span>
                                          <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
                                          <span class="n">difference_estimation_func</span><span class="o">=</span><span class="n">difference_estimation_func</span><span class="p">,</span>
                                          <span class="n">shapley_config</span><span class="o">=</span><span class="n">gcm</span><span class="o">.</span><span class="n">shapley</span><span class="o">.</span><span class="n">ShapleyConfig</span><span class="p">(</span><span class="n">approximation_method</span><span class="o">=</span><span class="n">gcm</span><span class="o">.</span><span class="n">shapley</span><span class="o">.</span><span class="n">ShapleyApproximationMethods</span><span class="o">.</span><span class="n">PERMUTATION</span><span class="p">,</span> <span class="n">num_permutations</span><span class="o">=</span><span class="mi">50</span><span class="p">)),</span>
        <span class="n">confidence_level</span><span class="o">=</span><span class="n">confidence_level</span><span class="p">,</span>
        <span class="n">num_bootstrap_resamples</span><span class="o">=</span><span class="n">num_bootstrap_resamples</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">difference_contribs</span><span class="p">,</span> <span class="n">uncertainty_contribs</span>

<span class="n">median_diff_contribs</span><span class="p">,</span> <span class="n">median_diff_uncertainty</span> <span class="o">=</span> <span class="n">calculate_difference_estimation</span><span class="p">(</span><span class="n">causal_model</span><span class="p">,</span> <span class="n">df_old</span><span class="p">,</span> <span class="n">df_new</span><span class="p">,</span> <span class="s1">&#39;sale&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Evaluating set functions...: 100%|██████████| 61/61 [00:02&lt;00:00, 30.45it/s]
Evaluating set functions...: 100%|██████████| 62/62 [00:01&lt;00:00, 31.30it/s]
Evaluating set functions...: 100%|██████████| 59/59 [00:01&lt;00:00, 30.60it/s]
Evaluating set functions...: 100%|██████████| 62/62 [00:03&lt;00:00, 16.57it/s]
Estimating bootstrap interval...: 100%|██████████| 4/4 [00:14&lt;00:00,  3.71s/it]
</pre></div></div>
</div>
<p>Then we plot drivers’ contribution to KPI changes visually, followed by a tabular format.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gcm</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">bar_plot</span><span class="p">(</span><span class="n">median_diff_contribs</span><span class="p">,</span> <span class="n">median_diff_uncertainty</span><span class="p">,</span> <span class="s1">&#39;Contribution&#39;</span><span class="p">,</span> <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/example_notebooks_sales_attribution_intervention_37_0.png" src="../_images/example_notebooks_sales_attribution_intervention_37_0.png" />
</div>
</div>
<p>Here, we see that ‘sp_spend’ has the larges contribution to the change in the mean of ‘sale’, while the ‘discount’ and ‘special_shopping_event’ has little to none contribution. This aligns with the way how the data was generated.</p>
<p>Taking a look at the tabular overview to look for significance based on the confidence intervals:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">show_tabular</span><span class="p">(</span><span class="n">median_contribs</span><span class="p">,</span> <span class="n">uncertainty_contribs</span><span class="p">):</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">median_contrib</span> <span class="ow">in</span> <span class="n">median_contribs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">,</span> <span class="n">median</span><span class="o">=</span><span class="n">median_contrib</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="n">uncertainty_contribs</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ub</span><span class="o">=</span><span class="n">uncertainty_contribs</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">median</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="s1">&#39;lb&#39;</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="s1">&#39;ub&#39;</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># show_tabular(median_contribs, uncertainty_contribs)</span>
<span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">show_tabular</span><span class="p">(</span><span class="n">median_diff_contribs</span><span class="p">,</span> <span class="n">median_diff_uncertainty</span><span class="p">))</span>
<span class="n">result_df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>median</th>
      <th>lb</th>
      <th>ub</th>
    </tr>
    <tr>
      <th>node</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>discount</th>
      <td>404.249464</td>
      <td>-2541.978891</td>
      <td>1871.992788</td>
    </tr>
    <tr>
      <th>dpv</th>
      <td>-17030.755266</td>
      <td>-20822.520925</td>
      <td>-12808.318982</td>
    </tr>
    <tr>
      <th>dsp_spend</th>
      <td>13230.332551</td>
      <td>8285.398025</td>
      <td>15570.497543</td>
    </tr>
    <tr>
      <th>sale</th>
      <td>2385.261508</td>
      <td>-3828.367497</td>
      <td>5810.297447</td>
    </tr>
    <tr>
      <th>sp_spend</th>
      <td>80356.934864</td>
      <td>74540.709426</td>
      <td>87494.532581</td>
    </tr>
    <tr>
      <th>special_shopping_event</th>
      <td>-1105.261287</td>
      <td>-2518.043702</td>
      <td>929.361176</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Next, we remove all variables that have a 0 as part of their confidence interval or are negative, i.e., do not have a clear significant positive contribution:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">filter_significant_rows</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">ub_col</span><span class="p">,</span> <span class="n">lb_col</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
        <span class="n">significant_rows</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[(</span><span class="n">result_df</span><span class="p">[</span><span class="n">ub_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">result_df</span><span class="p">[</span><span class="n">lb_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
        <span class="n">significant_rows</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[(</span><span class="n">result_df</span><span class="p">[</span><span class="n">ub_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">result_df</span><span class="p">[</span><span class="n">lb_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid direction. Choose &#39;positive&#39; or &#39;negative&#39;.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">significant_rows</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">positive_significant_rows</span> <span class="o">=</span> <span class="n">filter_significant_rows</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="s1">&#39;ub&#39;</span><span class="p">,</span> <span class="s1">&#39;lb&#39;</span><span class="p">)</span>
<span class="n">positive_significant_rows</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>median</th>
      <th>lb</th>
      <th>ub</th>
    </tr>
    <tr>
      <th>node</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dsp_spend</th>
      <td>13230.332551</td>
      <td>8285.398025</td>
      <td>15570.497543</td>
    </tr>
    <tr>
      <th>sp_spend</th>
      <td>80356.934864</td>
      <td>74540.709426</td>
      <td>87494.532581</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>This tells us, ‘dsp_spend’ and ‘sp_spend’ had a significantly positive contribution to the shift in ‘sale’.</p>
</section>
<section id="5.-Optimal-intervention">
<h2>5. Optimal intervention<a class="headerlink" href="#5.-Optimal-intervention" title="Link to this heading">#</a></h2>
<p>Section 4 above helps us to understand drivers for past growth. Now, looking forward to business planning, we conduct interventions to understand incremental contributions to KPIs. Intuitively, the spend types resulting in higher returns should be doubled down on. Here, we explicitly remove ‘sale’, ‘dpv’ and ‘special_shopping_event’ as a possible intervention targets.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">intervention_influence</span><span class="p">(</span><span class="n">causal_model</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">non_interveneable_nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confidence_level</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">prints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threshold_insignificant</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">):</span>
    <span class="n">progress_bar_was_on</span> <span class="o">=</span> <span class="n">gcm</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_progress_bars</span>

    <span class="k">if</span> <span class="n">progress_bar_was_on</span><span class="p">:</span>
        <span class="n">gcm</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">disable_progress_bars</span><span class="p">()</span>

    <span class="n">causal_effects</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">causal_effects_confidence_interval</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">capped_effects</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">non_interveneable_nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">non_interveneable_nodes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">causal_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">non_interveneable_nodes</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Define interventions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">intervention</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">step_size</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">non_intervention</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span>

        <span class="n">interventions_alternative</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">intervention</span><span class="p">}</span>
        <span class="n">interventions_reference</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">non_intervention</span><span class="p">}</span>

        <span class="n">effect</span> <span class="o">=</span> <span class="n">gcm</span><span class="o">.</span><span class="n">confidence_intervals</span><span class="p">(</span>
            <span class="n">partial</span><span class="p">(</span><span class="n">gcm</span><span class="o">.</span><span class="n">average_causal_effect</span><span class="p">,</span>
                    <span class="n">causal_model</span><span class="o">=</span><span class="n">causal_model</span><span class="p">,</span>
                    <span class="n">target_node</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                    <span class="n">interventions_alternative</span><span class="o">=</span><span class="n">interventions_alternative</span><span class="p">,</span>
                    <span class="n">interventions_reference</span><span class="o">=</span><span class="n">interventions_reference</span><span class="p">,</span>
                    <span class="n">num_samples_to_draw</span><span class="o">=</span><span class="mi">10000</span><span class="p">),</span>
            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">num_bootstrap_resamples</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
            <span class="n">confidence_level</span><span class="o">=</span><span class="n">confidence_level</span><span class="p">)</span>

        <span class="n">causal_effects</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">effect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">causal_effects_confidence_interval</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">effect</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Apply non-negativity constraint - Here, spend cannot be negative. However, small negative values can happen in the analysis due to misspecifications.</span>
        <span class="k">if</span>  <span class="n">node</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_spend&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">causal_effects</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">causal_effects</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">causal_effects_confidence_interval</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">progress_bar_was_on</span><span class="p">:</span>
        <span class="n">gcm</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_progress_bars</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">causal_effects</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prints</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">causal_effects</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">causal_effects</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">causal_effects</span><span class="p">[</span><span class="n">node</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">threshold_insignificant</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Increasing&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">step_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Decreasing&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2"> by </span><span class="si">{</span><span class="n">step_size</span><span class="si">}</span><span class="s2"> has no significant effect on </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Increasing&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">step_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Decreasing&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2"> by </span><span class="si">{</span><span class="n">step_size</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;increases&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">causal_effects</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;decreases&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;by around </span><span class="si">{</span><span class="n">causal_effects</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="si">}</span><span class="s2"> with a confidence interval (</span><span class="si">{</span><span class="n">confidence_level</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">}</span><span class="s2">%) of </span><span class="si">{</span><span class="n">causal_effects_confidence_interval</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">all_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">causal_effects</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">all_causal_effects</span> <span class="o">=</span> <span class="p">[</span><span class="n">causal_effects</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_variables</span><span class="p">]</span>
    <span class="n">all_lower_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">causal_effects_confidence_interval</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_variables</span><span class="p">]</span>
    <span class="n">all_upper_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">causal_effects_confidence_interval</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_variables</span><span class="p">]</span>
    <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Variable&#39;</span><span class="p">:</span> <span class="n">all_variables</span><span class="p">,</span>
                              <span class="s1">&#39;Causal Effect&#39;</span><span class="p">:</span> <span class="n">all_causal_effects</span><span class="p">,</span>
                              <span class="s1">&#39;Lower CI&#39;</span><span class="p">:</span> <span class="n">all_lower_bounds</span><span class="p">,</span>
                              <span class="s1">&#39;Upper CI&#39;</span><span class="p">:</span> <span class="n">all_upper_bounds</span><span class="p">},</span>
                             <span class="n">index</span> <span class="o">=</span> <span class="n">all_variables</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result_df</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">interv_result</span> <span class="o">=</span> <span class="n">intervention_influence</span><span class="p">(</span><span class="n">causal_model</span><span class="o">=</span><span class="n">causal_model</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;sale&#39;</span><span class="p">,</span> <span class="n">non_interveneable_nodes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dpv&#39;</span><span class="p">,</span> <span class="s1">&#39;sale&#39;</span><span class="p">,</span> <span class="s1">&#39;special_shopping_event&#39;</span><span class="p">],</span> <span class="n">prints</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">interv_result</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/runner/.cache/pypoetry/virtualenvs/dowhy-n6DJFijf-py3.9/lib/python3.9/site-packages/joblib/externals/loky/process_executor.py:782: UserWarning: A worker stopped while some jobs were given to the executor. This can be caused by a too short worker timeout or by a memory leak.
  warnings.warn(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;dsp_spend&#39;: 17.24967418278742, &#39;sp_spend&#39;: 251.46429418905464, &#39;discount&#39;: -0.3838008170953823}
Increasing sp_spend by 1 increases sale by around 251.46429418905464 with a confidence interval (95.0%) of [189.23222528 297.30733219].
Increasing dsp_spend by 1 increases sale by around 17.24967418278742 with a confidence interval (95.0%) of [ 2.88751799 40.04585586].
Increasing discount by 1 decreases sale by around -0.3838008170953823 with a confidence interval (95.0%) of [-1.04614227  1.0169307 ].
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Causal Effect</th>
      <th>Lower CI</th>
      <th>Upper CI</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dsp_spend</th>
      <td>dsp_spend</td>
      <td>17.249674</td>
      <td>2.887518</td>
      <td>40.045856</td>
    </tr>
    <tr>
      <th>sp_spend</th>
      <td>sp_spend</td>
      <td>251.464294</td>
      <td>189.232225</td>
      <td>297.307332</td>
    </tr>
    <tr>
      <th>discount</th>
      <td>discount</td>
      <td>-0.383801</td>
      <td>-1.046142</td>
      <td>1.016931</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We similarly filter to positively significant interventions, i.e., the spending with statistically significant positive returns. The interpretation is, for each dollar spent on one type of ad, we receive X amount in return, with X indicated in the ‘Causal Effect’ column.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filter_significant_rows</span><span class="p">(</span><span class="n">interv_result</span><span class="p">,</span> <span class="s1">&#39;positive&#39;</span><span class="p">,</span> <span class="s1">&#39;Upper CI&#39;</span><span class="p">,</span> <span class="s1">&#39;Lower CI&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable</th>
      <th>Causal Effect</th>
      <th>Lower CI</th>
      <th>Upper CI</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dsp_spend</th>
      <td>dsp_spend</td>
      <td>17.249674</td>
      <td>2.887518</td>
      <td>40.045856</td>
    </tr>
    <tr>
      <th>sp_spend</th>
      <td>sp_spend</td>
      <td>251.464294</td>
      <td>189.232225</td>
      <td>297.307332</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>This tells us that there is a clear benefit in doubling down on ‘sp_spend’ and ‘dsp_spend’. Note that the quantitative numbers here can be off due to model misspecifications, but they nevertheless provide some helpful insights.</p>
</section>
<section id="Summary">
<h2>Summary<a class="headerlink" href="#Summary" title="Link to this heading">#</a></h2>
<p>This advertiser comes to us to understand what drove past growth. Starting with a causal graph drawn from domain knowledge, we refined the graph to prune unnecessary nodes and edges. Then we fit a causal attribution model in Section 4 to test which types of investment changes lead to KPI growth. We find that increases in both dsp_spend and sp_spend contribute to KPIs growth in 2024 vs. 2023. This conclusion helps the analytics team to understand root causes of past sales growth. Looking forward
to future budget planning, we conducted interventions to understand incremental return on investment (iROI), and identify those types of spend way above $1 to double down on.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="counterfactual_fairness_dowhy.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Counterfactual Fairness</p>
      </div>
    </a>
    <a class="right-next"
       href="dowhy_ihdp_data_example.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">DoWhy example on ihdp (Infant Health and Development Program) dataset</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#The-Scenario">The Scenario</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#1.-Explore-the-data">1. Explore the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#2.-Draw-causal-graph">2. Draw causal graph</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#2.1.Set-up-basic-causal-graphs">2.1.Set up basic causal graphs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#2.2.-Prune-nodes-and-edges">2.2. Prune nodes and edges</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#3.-Fit-causal-graph">3. Fit causal graph</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#4.-Identify-causal-drivers-for-KPI-changes">4. Identify causal drivers for KPI changes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#5.-Optimal-intervention">5. Optimal intervention</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Summary">Summary</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/example_notebooks/sales_attribution_intervention.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2022, PyWhy contributors.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>